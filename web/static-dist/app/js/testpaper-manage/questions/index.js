webpackJsonp(["app/js/testpaper-manage/questions/index"],[function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_esEventEmitter=__webpack_require__("63fff8fb24f3bd1f61cd");_interopRequireDefault(_esEventEmitter);__webpack_require__("b3c50df5d8bf6315aeba");var _notify=__webpack_require__("b334fd7e4c5a19234db2"),_notify2=_interopRequireDefault(_notify),_batchSelect=__webpack_require__("de585ca0d3c2d0205c51"),_batchSelect2=_interopRequireDefault(_batchSelect),_deleteAction=__webpack_require__("f637e828bcb096623369"),_deleteAction2=_interopRequireDefault(_deleteAction),_questionOperate=__webpack_require__("1e0cf618bc778b8ab554"),Picker=function(){function Picker($button,$typeNav,$form){_classCallCheck(this,Picker),this.$button=$button,this.$typeNav=$typeNav,this.$form=$form,this.$modal=$("#testpaper-confirm-modal"),this.currentType=this.$typeNav.find(".active").children().data("type"),this._initEvent(),this._initSortList(),this.questions=[]}return _createClass(Picker,[{key:"_initEvent",value:function(){var _this=this;this.$button.on("click",function(event){return _this._showPickerModal(event)}),this.$typeNav.on("click","li",function(event){return _this._changeNav(event)}),this.$form.on("click",".request-save",function(event){return _this._confirmSave(event)}),this.$modal.on("click",".confirm-submit",function(event){return _this._submitSave(event)})}},{key:"_initSortList",value:function(){this.$form.find("table").sortable({containerSelector:"table",itemPath:"> tbody",itemSelector:"tr",placeholder:'<tr class="placeholder"/>',onDrop:function(item,container,_super){console.log(item),console.log(container),_super(item,container),item.hasClass("have-sub-questions")&&!function(){var $tbody=item.parents("tbody");$tbody.find("tr.is-question").each(function(){var $tr=$(this);$tbody.find("[data-parent-id="+$tr.data("id")+"]").detach().insertAfter($tr)})}()}})}},{key:"_showPickerModal",value:function(event){var excludeIds=[];$('[data-type="'+this.currentType+'"]').find('[name="questionId[]"]').each(function(){excludeIds.push($(this).val())});var $modal=$("#modal").modal();$modal.data("manager",this),$.get(this.$button.data("url"),{excludeIds:excludeIds.join(","),type:this.currentType},function(html){$modal.html(html)})}},{key:"_changeNav",value:function(event){var $target=$(event.currentTarget),type=$target.children().data("type");this.currentType=type,this.$typeNav.find("li").removeClass("active"),$target.addClass("active"),this.$form.find('[data-role="question-body"]').addClass("hide"),this.$form.find("#testpaper-items-"+type).removeClass("hide")}},{key:"_confirmSave",value:function(event){var isOk=this._validateScore();if(isOk){if($('[name="passedScore"]').length>0){var passedScoreErrorMsg=$(".passedScoreDiv").siblings(".help-block").html();if(""!=$.trim(passedScoreErrorMsg))return}var stats=this._calTestpaperStats(),html="";$.each(stats,function(index,statsItem){var tr="<tr>";tr+="<td>"+statsItem.name+"</td>",tr+="<td>"+statsItem.count+"</td>",tr+="<td>"+statsItem.score.toFixed(1)+"</td>",tr+="</tr>",html+=tr}),this.$modal.find(".detail-tbody").html(html),this.$modal.modal("show")}}},{key:"_validateScore",value:function(){var isOk=!0;return 0==this.$form.find('[name="scores[]"]').length&&((0,_notify2["default"])("danger","请选择题目。"),isOk=!1),this.$form.find('input[type="text"][name="scores[]"]').each(function(){var score=$(this).val();"0"==score&&((0,_notify2["default"])("danger","题目分值不能为0。"),isOk=!1),/^(([1-9]{1}\d{0,2})|([0]{1}))(\.(\d){1})?$/.test(score)||((0,_notify2["default"])("danger","题目分值只能填写数字，并且在3位数以内，保留一位小数。"),$(this).focus(),isOk=!1)}),isOk}},{key:"_calTestpaperStats",value:function(){var stats={},self=this;this.$typeNav.find("li").each(function(){var type=$(this).find("a").data("type"),name=$(this).find("a").data("name");stats[type]={name:name,count:0,score:0,missScore:0},self.$form.find("#testpaper-items-"+type).find('[name="scores[]"]').each(function(){var itemType=$(this).closest("tr").data("type"),score="material"==itemType?0:parseFloat($(this).val()),question={};"material"!=itemType&&stats[type].count++,stats[type].score+=score,stats[type].missScore=parseFloat($(this).data("miss-score"));var questionId=$(this).closest("tr").data("id");question.id=questionId,question.score=score,question.missScore=parseFloat($(this).data("miss-score")),question.type=type,self.questions.push(question)})});var total={name:Translator.trans("总计"),count:0,score:0};return $.each(stats,function(index,statsItem){total.count+=statsItem.count,total.score+=statsItem.score}),stats.total=total,stats}},{key:"_submitSave",value:function(event){$.post(this.$form.attr("action"),{questions:this.questions},function(result){result["goto"]&&(window.location.href=result["goto"])})}}]),Picker}(),$form=$("#question-checked-form");new Picker($('[data-role="pick-item"]'),$(".nav-mini"),$form),new _batchSelect2["default"]($form),new _deleteAction2["default"]($form),(0,_questionOperate.replaceQuestion)($form,$("#modal")),(0,_questionOperate.deleteQuestion)($form)}]);