{"version":3,"sources":["app/Resources/static-src/app/js/activity/video/index.js"],"names":["VideoPlay","recorder","player","intervalId","emitter","$","length","_playerSwf","_playVideo","record","setInterval","addVideoPlayerCounter","swf_dom","embedSWF","data","wmode","allowFullScreen","messenger","name","project","children","type","on","msg","playing","_onFinishLearnTask","currentTime","emit","then","clearInterval","catch","error","console","VideoRecorder","container","interval","$container","activityId","playerCounter","store","get","watchTime","url","post","response","status","window","location","reload","set","videoplay","play"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import swfobject from 'es-swfobject';\nimport EsMessenger from '../../../common/messenger';\nimport ActivityEmitter from '../activity-emitter';\nimport 'store';\n\nclass VideoPlay {\n  constructor(recorder) {\n    this.player = {};\n    this.intervalId = null;\n    this.recorder = recorder;\n    this.emitter = new ActivityEmitter();\n\n  }\n\n  play() {\n    if ($('#swf-player').length) {\n      this._playerSwf();\n    } else {\n      this._playVideo();\n    }\n    this.record();\n  }\n\n  record() {\n    this.intervalId = setInterval(() => {\n      this.recorder.addVideoPlayerCounter(this.emitter, this.player);\n    }, 1000);\n  }\n\n  getPlay() {\n    return this.player;\n  }\n\n  _playerSwf() {\n    const swf_dom = 'swf-player';\n    swfobject.embedSWF($('#' + swf_dom).data('url'),\n      swf_dom, '100%', '100%', \"9.0.0\", null, null, {\n        wmode: 'opaque',\n        allowFullScreen: 'true'\n      });\n  }\n\n  _playVideo() {\n    var messenger = new EsMessenger({\n      name: 'partner',\n      project: 'PlayerProject',\n      children: [],\n      type: 'parent'\n    });\n\n    messenger.on(\"ended\", (msg) => {\n      this.player.playing = false;\n      this._onFinishLearnTask(msg);\n    });\n\n    messenger.on(\"playing\", (msg) => {\n      this.player.playing = true;\n    });\n\n    messenger.on(\"paused\", (msg) => {\n      this.player.playing = false;\n    });\n\n    messenger.on(\"timechange\", (msg) => {\n      this.player.currentTime = msg.currentTime;\n    })\n  }\n\n  _onFinishLearnTask(msg) {\n    this.emitter.emit('finish', {data: msg}).then(() => {\n      clearInterval(this.intervalId)\n    }).catch((error) => {\n      console.error(error);\n    });\n  }\n\n}\n\n\nclass VideoRecorder {\n  constructor(container) {\n    this.container = container;\n    this.interval = 120;\n  }\n\n  addVideoPlayerCounter(emitter, player) {\n    let $container = $(this.container);\n    let activityId = $container.data('id');\n    let playerCounter = store.get(\"activity_id_\" + activityId + \"_playing_counter\");\n    if (!playerCounter) {\n      playerCounter = 0;\n    }\n    if (!(player && player.playing)) {\n      return false;\n    }\n    if (playerCounter >= this.interval) {\n      emitter.emit('watching', {watchTime: this.interval}).then(() => {\n        let url = $(\"#video-content\").data('watchUrl');\n        $.post(url, function (response) {\n          if (response && response.status == 'error') {\n            window.location.reload();\n          }\n        })\n      }).catch((error) => {\n        console.error(error);\n      });\n      playerCounter = 0;\n    } else if (player.playing) {\n      playerCounter++;\n    }\n    store.set(\"activity_id_\" + activityId + \"_playing_counter\", playerCounter);\n  }\n\n}\n\nlet recorder = new VideoRecorder('#video-content');\nlet videoplay = new VideoPlay(recorder);\nvideoplay.play();\n"]}