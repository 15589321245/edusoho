{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/testpaper/index.js"],"names":["Testpaper","$element","$step2_form","find","$step3_form","$parentiframe","$","window","parent","document","scoreSlider","_init","setValidateRule","initEvent","initStepForm2","on","changeTestpaper","event","showRedoInterval","startTimeCheck","changeEndTime","changeCondition","initSelectTestpaper","val","validator","addMethod","value","element","optional","test","format","validate","onkeyup","rules","title","required","trim","maxlength","mediaId","digits","limitedTime","startTime","DateAndTime","redoInterval","arithmeticFloat","max","messages","data","$option","passScore","getItemsTable","closest","score","Math","ceil","text","initScoreSlider","parseInt","hide","$target","currentTarget","$this","show","dateTimePicker","removeClass","addClass","getElementById","option","start","connect","tooltips","step","range","updateOptions","noUiSlider","create","values","handle","toFixed","css","html","append","url","testpaperId","post","Date","$starttime","is","Format","datetimepicker","autoclose","language","minView","endDate","now","height","form","date","valueOf"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import { dateFormat } from '../../../common/unit';\n\nclass Testpaper {\n\tconstructor($element) {\n\t\tthis.$element = $element;\n    this.$step2_form  = this.$element.find('#step2-form');\n    this.$step3_form  = this.$element.find('#step3-form');\n    this.$parentiframe = $(window.parent.document).find('#task-create-content-iframe');\n    this.scoreSlider = null;\n    this._init();\n  }\n\n  _init() {\n    dateFormat();\n    this.setValidateRule();\n    this.initEvent();\n    this.initStepForm2();\n  }\n\n  initEvent() {\n  \tthis.$element.find('#testpaper-media').on('change', event=>this.changeTestpaper(event));\n  \tthis.$element.find('input[name=doTimes]').on('change', event=>this.showRedoInterval(event));\n  \tthis.$element.find('input[name=\"testMode\"]').on('change',event=>this.startTimeCheck(event))\n    this.$element.find('input[name=\"length\"]').on('blur',event=>this.changeEndTime(event));\n    this.$element.find('#condition-select').on('change',event=>this.changeCondition(event));\n    this.initSelectTestpaper(this.$element.find('#testpaper-media').find('option:selected'),$('[name=\"finishScore\"]').val());\n  }\n\n  setValidateRule() {\n    $.validator.addMethod(\"arithmeticFloat\",function(value,element){  \n      return this.optional( element ) || /^[0-9]+(\\.[0-9]?)?$/.test(value);\n    }, $.validator.format(\"必须为正数，保留一位小数\"));\n\n    $.validator.addMethod(\"positiveInteger\",function(value,element){  \n      return this.optional( element ) || /^[1-9]\\d*$/.test(value);\n    }, $.validator.format(\"必须为正整数\"));\n\n    \n  }\n\n  initStepForm2() {\n    var validator = this.$step2_form.validate({\n        onkeyup: false,\n        rules: {\n            title: {\n              required:true,\n              trim: true,\n              maxlength: 50,\n            },\n            mediaId: {\n              required: true,\n              digits:true\n            },\n            limitedTime:{\n              required:true,\n              digits:true\n            },\n            startTime:{\n              required:function(){\n                return ($('[name=\"doTimes\"]:checked').val() == 1) && ($('[name=\"testMode\"]:checked').val() == 'realTime');\n              },\n              DateAndTime:function(){\n                return ($('[name=\"doTimes\"]:checked').val() == 1) && ($('[name=\"testMode\"]:checked').val() == 'realTime');\n              }\n            },\n            redoInterval:{\n              required:function(){\n                return $('[name=\"doTimes\"]:checked').val() == 0;\n              },\n              arithmeticFloat:true,\n              max:1000000000\n            }\n        },\n        messages: {\n          mediaId: {\n            required:'请选择%display%',\n          },\n          redoInterval: {\n            max: \"最大值不能超过1000000000\"\n          },\n        }\n    });\n    this.$step2_form.data('validator',validator);\n  }\n\n  initSelectTestpaper($option, passScore='') {\n    let mediaId = $option.val();\n    if (mediaId != '') {\n      this.getItemsTable($option.closest('select').data('getTestpaperItems'), mediaId);\n      let score = $option.data('score');\n      if (passScore == '') {\n        passScore = Math.ceil(score * 0.6);\n      }\n      $('#score-single-input').val(passScore);\n      $('.js-score-total').text(score);\n\n      $('input[name=\"title\"]').val($option.text());\n      this.initScoreSlider(parseInt(passScore),parseInt(score));\n    } else {\n      $('#questionItemShowDiv').hide();\n    }\n  }\n\n  changeTestpaper(event) {\n    let $target = $(event.currentTarget);\n    let $option = $target.find('option:selected');\n    this.initSelectTestpaper($option);\n  }\n\n  showRedoInterval(event) {\n    let $this = $(event.currentTarget);\n    if ($this.val() == 1) {\n      $('#lesson-redo-interval-field').closest('.form-group').hide();\n      $('.starttime-check-div').show();\n      this.dateTimePicker();\n    } else {\n      $('#lesson-redo-interval-field').closest('.form-group').show();\n      $('.starttime-check-div').hide();\n    }\n  }\n\n  startTimeCheck(event) {\n    var $this = $(event.currentTarget);\n\n    if ($this.val() == 'realTime') {\n      $('.starttime-input').removeClass('hidden');\n      this.dateTimePicker();\n    } else {\n      $('.starttime-input').addClass('hidden');\n      //$('input[name=\"startTime\"]').val('0');\n    }\n  }\n\n  changeEndTime(event) {\n    let startTime = $('input[name=\"startTime\"]:visible').val();\n    // if (startTime) {\n    //   this.showEndTime(Date.parse(startTime));\n    // }\n  }\n\n  changeCondition(event) {\n    let $this = $(event.currentTarget);\n    let value = $this.find('option:selected').val();\n    value!='score' ? $('.js-score-form-group').addClass('hidden') : $('.js-score-form-group').removeClass('hidden');\n  }\n\n  initScoreSlider(passScore,score) {\n    let scoreSlider = document.getElementById('score-slider');\n    let option = {\n      start: passScore,\n      connect: [true, false],\n      tooltips: [true],\n      step: 1,\n      range: {\n        'min': 0,\n        'max': score\n      }\n    }\n    if(this.scoreSlider) {\n      this.scoreSlider.updateOptions(option);\n    }else {\n      this.scoreSlider = noUiSlider.create(scoreSlider,option);\n      scoreSlider.noUiSlider.on('update', function( values, handle ){\n        $('.noUi-tooltip').text(`${(values[handle]/score*100).toFixed(0)}%`);\n        $('.js-score-tooltip').css('left',`${(values[handle]/score*100).toFixed(0)}%`);\n        $('.js-passScore').text(parseInt(values[handle]));\n        $('input[name=\"finishScore\"]').val(parseInt(values[handle]));\n      });\n    }\n    let html = `<div class=\"score-tooltip js-score-tooltip\"><div class=\"tooltip top\" role=\"tooltip\" style=\"\">\n      <div class=\"tooltip-arrow\"></div>\n      <div class=\"tooltip-inner \">\n      达标分数：<span class=\"js-passScore\">${passScore}</span>分\n      </div>\n      </div></div>`;\n    $('.noUi-handle').append(html);\n    $('.noUi-tooltip').text(`${(passScore/score*100).toFixed(0)}%`);\n    $('.js-score-tooltip').css('left',`${(passScore/score*100).toFixed(0)}%`);\n  }\n\n  getItemsTable(url, testpaperId) {\n  \t$.post(url, {testpaperId:testpaperId},function(html){\n      $('#questionItemShowTable').html(html);\n      $('#questionItemShowDiv').show();\n    });\n  }\n\n  dateTimePicker() {\n    let data = new Date();\n    let $starttime = $('input[name=\"startTime\"]');\n\n    if ($starttime.is(':visible') && ($starttime.val() == '' || $starttime.val() == '0')) {\n      $starttime.val(data.Format('yyyy-MM-dd hh:mm'));\n    }\n   \n    $starttime.datetimepicker({\n      autoclose: true,\n      format: 'yyyy-mm-dd hh:ii',\n      language:\"zh\",\n      minView: 'hour',\n      endDate: new Date(Date.now() + 86400 * 365 * 10 *1000)\n    })\n    .on('show', event => {\n      this.$parentiframe.height($('body').height() + 240);\n    })\n    .on('hide', event => {\n      this.$step2_form.data('validator').form();\n      this.$parentiframe.height($('body').height());\n    })\n    .on('changeDate',event =>{\n      let date = event.date.valueOf();\n      // this.showEndTime(date);\n    });\n    $starttime.datetimepicker('setStartDate',data);\n    // this.showEndTime(Date.parse($starttime.val()));\n  }\n\n  // showEndTime(date) {\n  //   let limitedTime = $('input[name=\"limitedTime\"]').val();\n  //   if (limitedTime != 0) {\n  //     let endTime = new Date(date + limitedTime * 60 * 1000);\n  //     let endDate = endTime.Format(\"yyyy-MM-dd hh:mm\");\n  //     $('#starttime-show').html(endDate);\n  //     $('.endtime-input').removeClass('hidden');\n  //     $('input[name=\"endTime\"]').val(endDate);\n  //   }else {\n  //     $('.endtime-input').addClass('hidden');\n  //   }\n  // }\n}\n\nnew Testpaper($('#iframe-content'));"]}