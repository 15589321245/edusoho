{% extends 'TopxiaAdminBundle::layout.html.twig' %}


{% set menu = 'admin_edu_cloud_sms' %} 

{% set script_controller = 'educloud/sms-setting' %}

{% block main %}
  {{ web_macro.flash_messages() }}

  {% if not smsStatus or smsStatus.status == 'error' %}
    <div class="panel panel-default">
      <table class="table table-striped table-hover" style="word-break:break-all;">
        <thead>
          <tr>
            <th style="text-align: center; width: 70%">原因</th>
            <th style="text-align: center; width: 30%">操作</th>
          </tr>
        </thead>
        <tbody style="text-align: center;">
          <tr>
            <td>
              您还未开通云短信服务
            </td>
            <td>
              <span class="btn btn-default btn-sm" data-toggle="modal" data-target="#modal" data-url="{{path('admin_edu_cloud_apply_for_sms')}}" > 申请开通云短信 </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  {% else %}
    {% set hasSchoolName = ('' != setting('cloud_sms.sms_school_name')|default('')) %}
    {% if smsStatus.status == "failed" and hasSchoolName and ('on' == setting('cloud_sms.show_message')|default('off')) %}
      <div class="alert alert-danger">
        <a href="{{path("admin_edu_cloud_sms_no_message")}}" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></a>
        {{ smsStatus.schoolNameError }}
      </div>
  {% endif %}

  <form class="form-horizontal" method="post" id="sms-form" novalidate="">
    <fieldset>
      {% if hasSchoolName %}
        <legend>短信设置</legend>
        <div class="form-group">
          <div class="col-md-3 control-label">
            <label class="pull-right">短信功能</label>
          </div>

          <div class="controls col-md-8 radios">
            <label>
              <input type="radio" name="sms_enabled" value="1"
              {% if (setting('cloud_sms.sms_enabled')|default('')) == '1' %}
                checked="checked"
              {% endif %}> 开启
            </label>
            <label>
              <input type="radio" name="sms_enabled" value="0" 
              {% if (setting('cloud_sms.sms_enabled')|default('')) != '1' %}
                checked="checked"
              {% endif %}> 关闭
            </label>
            <p class="help-block">短信开始使用后，将收取0.07元/条的费用</p>
          </div>
        </div>

      {% endif %}
        {% if smsStatus.status in ['passed','failed'] %}
          {% if ( not hasSchoolName ) and (smsStatus.status == 'failed') %}
            <div class="alert alert-danger">
              您的网校名称“{{setting('cloud_sms.sms_school_candidate_name')|default('')}}”未通过审核，原因是：{{ smsStatus.message|default('网校名称不符合规范') }}

              <span class="btn btn-default btn-sm" data-toggle="modal" data-target="#modal" data-url="{{path('admin_edu_cloud_apply_for_sms')}}" > 重新申请 </span>
            </div>

          {% else %}
            <div class="form-group">  
              <div class="col-md-3 control-label">
                <label for="sms-school-name" class="pull-right">网校名称</label>
              </div>
              <div class="col-md-5 controls">
                <input type="text" id="name" name="sms-school-name" class="form-control js-school-name" value="{{setting('cloud_sms.sms_school_name')|default('')}}" readonly="readonly">
                <p class="help-block"></p>
                <p>短信内容：“【<span id="js-sms-school-name">{{setting('cloud_sms.sms_school_name')|default('')}}</span>】您的验证码是：123456(请勿泄露)，此验证码30分钟内输入有效”</p>
              </div>
              <div class="col-md-2">
                <span class="btn btn-default js-alter-school-name" data-toggle="modal" data-target="#modal" data-url="{{path('admin_edu_cloud_apply_for_sms')}}">修改</span>
              </div>
            </div>  
          {% endif %}

        {% elseif  smsStatus.status == 'auditing' %}
          {% if hasSchoolName %}
            <div class="form-group">
              <div class="col-md-3 control-label">
                <label for="name" class="pull-right">网校名称</label>
              </div>
              <div class="col-md-5 controls">
                <input type="text" id="name" name="sms-school-name" class="form-control js-school-name" value="{{setting('cloud_sms.sms_school_name')|default('')}}" readonly="readonly">
                <p class="help-block"></p>
                <p>短信内容：“【<span id="js-sms-school-name">{{setting('cloud_sms.sms_school_name')|default('')}}</span>】您的验证码是：123456(请勿泄露)，此验证码30分钟内输入有效”</p>
              </div>
            </div>
          {% endif %}

          <div class="alert alert-warning">
            <span>网校名称【{{setting('cloud_sms.sms_school_candidate_name')|default('')}}】正在审核中 <a href="#js-apply-details" class="btn btn-default btn-sm" data-toggle="modal">详情</a></span>
          </div>
            
          <div class = "modal{#  fade #}" id="js-apply-details" role = "dialog">
            <div class = "modal-dialog">
              <div class = "modal-content">
                <div class = "modal-header">
                   <h4>申请详情</h4>
                </div>
                <div class = "modal-body">                                
          <table class="table table-striped order-table">
              <tbody>
                <tr> 
                  <th style="text-align: center;" width="30%">短信内容</th>
                  <td>【 {{ setting('cloud_sms.sms_school_candidate_name')|default('') }} 】您的验证码是：123456(请勿泄露)，此验证码30分钟内输入有效</td> 
                </tr>
                <tr> 
                  <th style="text-align: center;" width="30%">审核时间</th>
                  <td>
                    审核需24小时
                    {% if '' != (setting('cloud_sms.sms_school_name')|default('')) %}
                      ，期间短信验证功能仍可以正常使用
                    {% endif %}
                  </td> 
                </tr>
                <tr> 
                  <th style="text-align: center;" width="30%">短信价格</th> 
                  <td>0.07元/条</td> 
                </tr>
                <tr> 
                  <th style="text-align: center;" width="30%">审核状态</th> 
                  <td> 审核中 </td> 
                </tr>
              </tbody>
          </table>
                </div>
                <div class = "modal-footer">
                  <a class = "btn btn-primary" data-dismiss = "modal">关闭</a>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        {% if hasSchoolName %}
          <div class="js-usage" {% if (setting('cloud_sms.sms_enabled')|default('')) != '1' %}style="display:none;" {% endif %}>
            <legend>短信验证</legend>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th style="width:20%"></th>
                  <th style="width:30%">短信类型</th>
                  <th style="width:10%">类型编号</th>
                  <th style="width:20%">启用状态</th>
                  <th style="width:20%">发送方式</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                </tr>
                <tr>
                  <td rowspan="4" style="text-align:center;vertical-align:middle;font-size:18px;">身份验证
                  </td>
                  <td>手机绑定</td>
                  <td>1</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_bind" value="1"
                      {% if (setting('cloud_sms.sms_bind')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_bind" value="0" 
                        {% if (setting('cloud_sms.sms_bind')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                  <td rowspan="4" style="text-align:center;vertical-align:middle;font-size:18px;">自动单发
                  </td>
                </tr>
                <tr>
                  <td>登录密码重置</td>
                  <td>2</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_forget_password" value="1"
                      {% if (setting('cloud_sms.sms_forget_password')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_forget_password" value="0" 
                        {% if (setting('cloud_sms.sms_forget_password')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                <tr>
                  <td>支付密码重置</td>
                  <td>3</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_forget_pay_password" value="1"
                      {% if (setting('cloud_sms.sms_forget_pay_password')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_forget_pay_password" value="0" 
                        {% if (setting('cloud_sms.sms_forget_pay_password')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                <tr>
                  <td>使用网站余额支付</td>
                  <td>4</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_user_pay" value="1"
                      {% if (setting('cloud_sms.sms_user_pay')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_user_pay" value="0" 
                        {% if (setting('cloud_sms.sms_user_pay')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
              </tbody>
            </table>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th style="width:20%"></th>
                  <th style="width:30%">短信类型</th>
                  <th style="width:10%">类型编号</th>
                  <th style="width:20%">启用状态</th>
                  <th style="width:20%">发送方式</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                </tr>
                <tr>
                  <td rowspan="9" style="text-align:center;vertical-align:middle;font-size:18px;">教务通知
                  </td>
                  <td>新班级发布</td>
                  <td>5</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_classroom_publish" value="1"
                      {% if (setting('cloud_sms.sms_classroom_publish')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_classroom_publish" value="0" 
                        {% if (setting('cloud_sms.sms_classroom_publish')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                  <td rowspan="4" style="text-align:center;vertical-align:middle;font-size:18px;"> 
                  手动群发
                  </td>
                </tr>
                <tr>
                  <td>新课程发布</td>
                  <td>6</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_course_publish" value="1"
                      {% if (setting('cloud_sms.sms_course_publish')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_course_publish" value="0" 
                        {% if (setting('cloud_sms.sms_course_publish')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                <tr>
                  <td>新课时发布通知（普通课程）</td>
                  <td>7</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_normal_lesson_publish" value="1"
                      {% if (setting('cloud_sms.sms_normal_lesson_publish')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_normal_lesson_publish" value="0" 
                        {% if (setting('cloud_sms.sms_normal_lesson_publish')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                <tr>
                  <td>新课时发布通知（直播）</td>
                  <td>8</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_live_lesson_publish" value="1"
                      {% if (setting('cloud_sms.sms_live_lesson_publish')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_live_lesson_publish" value="0" 
                        {% if (setting('cloud_sms.sms_live_lesson_publish')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                {#<tr>
                  <td>预约辅导开课通知</td>
                  <td>9</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_user_pay" value="1"
                      {% if (setting('cloud_sms.sms_user_pay')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_user_pay" value="0" 
                        {% if (setting('cloud_sms.sms_user_pay')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr> #}
                <tr>
                  <td>直播开播前通知（提前1天）</td>
                  <td>9</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_live_play_one_day" value="1"
                      {% if (setting('cloud_sms.sms_live_play_one_day')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_live_play_one_day" value="0" 
                        {% if (setting('cloud_sms.sms_live_play_one_day')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                  <td rowspan="2" style="text-align:center;vertical-align:middle;font-size:18px;"> 
                  自动群发
                  </td>
                </tr>
                <tr>
                  <td>直播开播前通知（提前1小时）</td>
                  <td>10</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_live_play_one_hour" value="1"
                      {% if (setting('cloud_sms.sms_live_play_one_hour')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_live_play_one_hour" value="0" 
                        {% if (setting('cloud_sms.sms_live_play_one_hour')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                <tr>
                  <td>作业完成批阅</td>
                  <td>11</td>
                  <td class="radios">
                    {% if (is_plugin_installed('Homework')) %}
                      <label>
                        <input type="radio" name="sms_homework_correct" value="1"
                        {% if (setting('cloud_sms.sms_homework_correct')|default('')) == '1' %}
                          checked="checked"
                        {% endif %}> 开启
                      </label>
                      <label>
                          <input type="radio" name="sms_homework_correct" value="0" 
                          {% if (setting('cloud_sms.sms_homework_correct')|default('')) != '1' %}
                            checked="checked"
                          {% endif %}> 关闭
                      </label>
                    {% else %}
                      请先安装作业插件！
                    {% endif %}
                  </td>
                  <td rowspan="2" style="text-align:center;vertical-align:middle;font-size:18px;"> 
                  自动单发
                  </td>
                </tr>
                <tr>
                  <td>试卷完成批阅</td>
                  <td>12</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_testpaper_correct" value="1"
                      {% if (setting('cloud_sms.sms_testpaper_correct')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_testpaper_correct" value="0" 
                        {% if (setting('cloud_sms.sms_testpaper_correct')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
              </tbody>
            </table>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th style="width:20%"></th>
                  <th style="width:30%">短信类型</th>
                  <th style="width:10%">类型编号</th>
                  <th style="width:20%">启用状态</th>
                  <th style="width:20%">发送方式</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                </tr>
                <tr>
                  <td rowspan="4" style="text-align:center;vertical-align:middle;font-size:18px;">支付成功回执
                  </td>
                  <td>课程购买</td>
                  <td>13</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_course_buy_receipt" value="1"
                      {% if (setting('cloud_sms.sms_course_buy_receipt')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_course_buy_receipt" value="0" 
                        {% if (setting('cloud_sms.sms_course_buy_receipt')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                  <td rowspan="4" style="text-align:center;vertical-align:middle;font-size:18px;">自动单发
                  </td>
                </tr>
                <tr>
                  <td>班级购买</td>
                  <td>14</td>
                  <td class="radios">
                    <label>
                      <input type="radio" name="sms_classroom_buy_receipt" value="1"
                      {% if (setting('cloud_sms.sms_classroom_buy_receipt')|default('')) == '1' %}
                        checked="checked"
                      {% endif %}> 开启
                    </label>
                    <label>
                        <input type="radio" name="sms_classroom_buy_receipt" value="0" 
                        {% if (setting('cloud_sms.sms_classroom_buy_receipt')|default('')) != '1' %}
                          checked="checked"
                        {% endif %}> 关闭
                    </label>
                  </td>
                </tr>
                <tr>
                  <td>会员购买</td>
                  <td>15</td>
                  <td class="radios">
                    {% if is_plugin_installed('Vip') %}
                      <label>
                        <input type="radio" name="sms_vip_buy_receipt" value="1"
                        {% if (setting('cloud_sms.sms_vip_buy_receipt')|default('')) == '1' %}
                          checked="checked"
                        {% endif %}> 开启
                      </label>
                      <label>
                          <input type="radio" name="sms_vip_buy_receipt" value="0" 
                          {% if (setting('cloud_sms.sms_vip_buy_receipt')|default('')) != '1' %}
                            checked="checked"
                          {% endif %}> 关闭
                      </label>
                    {% else %}
                      请先安装会员插件！
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td>虚拟币充值</td>
                  <td>16</td>
                  <td class="radios">
                    {% if setting('coin.coin_enabled') %}
                      {% if is_plugin_installed('ChargeCoin') %}
                        <label>
                          <input type="radio" name="sms_coin_buy_receipt" value="1"
                          {% if (setting('cloud_sms.sms_coin_buy_receipt')|default('')) == '1' %}
                            checked="checked"
                          {% endif %}> 开启
                        </label>
                        <label>
                            <input type="radio" name="sms_coin_buy_receipt" value="0" 
                            {% if (setting('cloud_sms.sms_coin_buy_receipt')|default('')) != '1' %}
                              checked="checked"
                            {% endif %}> 关闭
                        </label>
                      {% else %}
                        请先安装虚拟币充值插件！
                      {% endif %}
                    {% else %}
                      请先开启虚拟币！
                    {% endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        {% endif %}
      </fieldset>

      {% if hasSchoolName %}
        <div class="form-group">
          <div class="controls col-md-offset-3 col-md-8">
            <button type="submit" class="btn btn-primary">提交</button>
          </div>
        </div>
      {% endif %}
      <input type="hidden" name="register-mode" value="{{ setting('auth.register_mode')}}">
      <input type="hidden" name="_csrf_token" value="{{ csrf_token('site') }}">

    </form>
  {% endif %}

{% endblock %}