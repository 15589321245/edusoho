{"version":3,"sources":["app/Resources/static-src/app/js/player/index.js"],"names":["Show","element","container","$","htmlDom","userId","data","userName","fileId","fileGlobalId","courseId","lessonId","timelimit","playerType","fileType","url","videoHeaderLength","enablePlaybackRates","watermark","accesskey","fingerprint","fingerprintSrc","fingerprintTime","balloonVideoPlayer","markerUrl","starttime","agentInWhiteList","disableVolumeButton","disablePlaybackButton","disableResolutionSwitcher","subtitles","initView","initEvent","html","show","create","mediaType","controlBar","statsInfo","globalId","textTrack","transToTextrack","textTracks","i","item","label","name","src","push","project","type","player","initPlayer","messenger","initMesseger","on","sendToParent","pause","currentTime","getCurrentTime","isCloudPalyer","time","get","setCurrentTime","play","getJSON","questions","setQuestions","finishUrl","markerId","id","post","answer","result","parseInt","getDuration","set","stop","del"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import PlayerFactory from './player-factory';\nimport EsMessenger from '../../common/messenger';\nimport DurationStorage from './util/duration-storage';\n\nclass Show {\n\n  constructor(element) {\n    let container = $(element);\n    this.htmlDom = $(element);\n    this.userId = container.data(\"userId\");\n    this.userName = container.data(\"userName\");\n    this.fileId = container.data(\"fileId\");\n    this.fileGlobalId = container.data(\"fileGlobalId\");\n\n    this.courseId = container.data(\"courseId\");\n    this.lessonId = container.data(\"lessonId\");\n    this.timelimit = container.data('timelimit');\n\n    this.playerType = container.data('player');\n    this.fileType = container.data('fileType');\n    this.url = container.data('url');\n    this.videoHeaderLength = container.data('videoHeaderLength');\n    this.enablePlaybackRates = container.data('enablePlaybackRates');\n    this.watermark = container.data('watermark');\n    this.accesskey = container.data('accessKey');\n    this.fingerprint = container.data('fingerprint');\n    this.fingerprintSrc = container.data('fingerprintSrc');\n    this.fingerprintTime = container.data('fingerprintTime');\n    this.balloonVideoPlayer = container.data('balloonVideoPlayer');\n    this.markerUrl = container.data('markerurl');\n    this.starttime = container.data('starttime');\n    this.agentInWhiteList = container.data('agentInWhiteList');\n    this.disableVolumeButton = container.data('disableVolumeButton');\n    this.disablePlaybackButton = container.data('disablePlaybackButton');\n    this.disableResolutionSwitcher = container.data('disableResolutionSwitcher');\n    this.subtitles = container.data('subtitles');\n\n    this.initView();\n    this.initEvent();\n  }\n\n  initView() {\n    let html = \"\";\n    if (this.fileType == 'video') {\n      if (this.playerType == 'local-video-player') {\n        html += '<video id=\"lesson-player\" style=\"width: 100%;height: 100%;\" class=\"video-js vjs-default-skin\" controls preload=\"auto\"></video>';\n      } else {\n        html += '<div id=\"lesson-player\" style=\"width: 100%;height: 100%;\"></div>';\n      }\n    } else if (this.fileType == 'audio') {\n      html += '<audio id=\"lesson-player\" style=\"width: 100%;height: 100%;\" class=\"video-js vjs-default-skin\" controls preload=\"auto\" poster=\"http://s.cn.bing.net/az/hprichbg/rb/MountScott_ZH-CN8412403132_1920x1080.jpg\"></audio>';\n    }\n    this.htmlDom.html(html);\n    this.htmlDom.show();\n  }\n\n  initPlayer() {\n    return PlayerFactory.create(\n      this.playerType, {\n        element: '#lesson-player',\n        url: this.url,\n        mediaType: this.fileType,\n        fingerprint: this.fingerprint,\n        fingerprintSrc: this.fingerprintSrc,\n        fingerprintTime: this.fingerprintTime,\n        watermark: this.watermark,\n        starttime: this.starttime,\n        agentInWhiteList: this.agentInWhiteList,\n        timelimit: this.timelimit,\n        enablePlaybackRates: this.enablePlaybackRates,\n        controlBar: {\n          disableVolumeButton: this.disableVolumeButton,\n          disablePlaybackButton: this.disablePlaybackButton,\n          disableResolutionSwitcher: this.disableResolutionSwitcher\n        },\n        statsInfo: {\n          accesskey: this.accesskey,\n          globalId: this.fileGlobalId,\n          userId: this.userId,\n          userName: this.userName\n        },\n        videoHeaderLength: this.videoHeaderLength,\n        textTrack: this.transToTextrack(this.subtitles)\n      }\n    );\n  }\n\n  transToTextrack(subtitles) {\n    let textTracks = [];\n    if (subtitles) {\n      for (let i in subtitles) {\n        let item = {\n          label: subtitles[i].name,\n          src: subtitles[i].url,\n          'default': (\"default\" in subtitles[i]) ? subtitles[i]['default'] : false\n        }\n        textTracks.push(item);\n      }\n    }\n\n    // set first item to default if no default\n    for (let i in textTracks) {\n      if (textTracks[i]['default']) {\n        return;\n      }\n      textTracks[0]['default'] = true;\n    }\n\n    return textTracks;\n  }\n\n  initMesseger() {\n    return new \n    ({\n      name: 'parent',\n      project: 'PlayerProject',\n      type: 'child'\n    });\n  }\n\n  isCloudPalyer() {\n    return 'balloon-cloud-video-player' == this.playerType;\n  }\n\n  initEvent() {\n    let player = this.initPlayer();\n    let messenger = this.initMesseger();\n    player.on(\"ready\", () => {\n      messenger.sendToParent(\"ready\", {pause: true, currentTime: player.getCurrentTime()});\n      if (!this.isCloudPalyer()) {\n        let time = DurationStorage.get(this.userId, this.fileId);\n        if (time > 0) {\n          player.setCurrentTime(time);\n        }\n        player.play();\n      } else if (this.isCloudPalyer()) {\n        if (this.markerUrl) {\n          $.getJSON(this.markerUrl, function (questions) {\n            player.setQuestions(questions);\n          });\n        }\n      }\n    });\n\n    player.on('answered', function (data) {\n      // @todo delete lessonId\n      var finishUrl = '/course/lesson/marker/' + data.markerId + '/question_marker/' + data.id + '/finish';\n      $.post(finishUrl, {\n        \"answer\": data.answer,\n        \"type\": data.type,\n        \"lessonId\": lessonId\n      }, function (result) {\n\n      }, 'json');\n\n    });\n\n    player.on(\"timechange\", (data) => {\n      messenger.sendToParent(\"timechange\", {pause: true, currentTime: player.getCurrentTime()});\n      if (!this.isCloudPalyer()) {\n        if (parseInt(player.getCurrentTime()) != parseInt(player.getDuration())) {\n          DurationStorage.set(this.userId, this.fileId, player.getCurrentTime());\n        }\n      }\n    });\n\n    player.on(\"paused\", () => {\n      messenger.sendToParent(\"paused\", {pause: true, currentTime: player.getCurrentTime()});\n    });\n\n    player.on(\"playing\", () => {\n      messenger.sendToParent(\"playing\", {pause: false, currentTime: player.getCurrentTime()});\n    });\n\n    player.on(\"ended\", () => {\n      messenger.sendToParent(\"ended\", {stop: true});\n      if (!this.isCloudPalyer()) {\n        DurationStorage.del(this.userId, this.fileId);\n      }\n    });\n  }\n\n\n}\nnew Show('#lesson-video-content');\n"]}