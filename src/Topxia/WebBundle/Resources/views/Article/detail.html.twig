{% extends 'TopxiaWebBundle:Article:layout.html.twig' %}

{% block title %}{{ article.title }} - {{ parent() }}{% endblock %}

{% block keywords %}{{ seoKeyword }}{% endblock %}

{% block description %}{{ seoDesc|plain_text(100) }}{% endblock %}

{% block article_main %}
  {{ load_script('thread/thread-show') }}
  <ul class="breadcrumb">
      <li><a href="{{path('article_show')}}">{{setting.name}}</a></li>
      {% for breadcrumb in breadcrumbs %}
        <li><a href="{{path('article_category',{categoryCode:breadcrumb.code})}}">{{breadcrumb.name}}</a></li>
      {% endfor %}
      <li class="active">正文</li>
  </ul>

  <h2 class="thread-title">{{article.title}}</h2>
     <div class="published-time pull-left">{{ article.publishedTime|date('Y-m-d H:i:s') }}</div>
     <div class="published-time pull-right">{{ article.hits|default(0) }} 次浏览</div>
     <p><br></p>
  <div class="thread-body">{{article.body |raw }}</div>

  <p class="clearfix">

    <div class="dropdown pull-right">
      <a href="javascript:;" class="btn btn-link" data-toggle="dropdown"><span class="glyphicon glyphicon-share"></span> 分享到</a>
      {% include 'TopxiaWebBundle:Common:share-dropdown.html.twig' with {type:'article'} %}
    </div>

  {% if tags %}
     <span class="text-muted">标签:</span>
    {% for tag in tags %}
         <span class="label label-info">{{tag.name}}</span>
    {% endfor %}
  {% endif %}
  <br>
  {% if article.source %}
     <span class="text-muted">原文出处: &nbsp;</span>
     {% if article.sourceUrl %}
       <a href="{{ article.sourceUrl }}" target="_blank">{{article.source}}</a>
     {% else %}
       {{article.source}}
     {% endif %}
  {% endif %}
  </p>
  <ul class="pager" style="margin-top:30px;">
    {% if articlePrevious %}
      <li class="previous"><a href="{{ path('article_detail',{id:articlePrevious.id}) }}">&larr; 上一篇</a></li>
    {% else %}
      <li class="previous disabled"><a href="javascript:;">&larr; 上一篇</a></li>
    {% endif %}

      {% if articleNext %}
      <li class="next"><a href="{{ path('article_detail',{id:articleNext.id}) }}"> 下一篇 &rarr;</a></li>
    {% else %}
      <li class="next disabled"><a href="javascript:;"> 下一篇 &rarr;</a></li>
    {% endif %}
  </ul>
  <form class="es-commet" method="post">
      <div class="es-commet-header">
        文章评论<span class="badge badge-primary">42</span>
      </div>
      <input type="hidden" name="_csrf_token" value="{{ csrf_token('site') }}">
      <textarea class="form-control" rows="6" placeholder="您的想法" name="content" {% if not app.user %}disabled=true{% endif %}></textarea>
      
      <div class="form-group clearfix">
        {% if not app.user %}<a href="{{ path('login') }}">登录</a> 后发表看法{% endif %}
        <button type="submit" class="btn btn-default pull-right {% if not app.user %}disabled{% endif %}" >发表评论</button>
      </div>
      
  </form>
  <div class="thread-show">
    <div class="panel panel-default">
      <div class="panel-body">
        <ul class="media-list thread-post-list thread-pripost-list">
          {% for post in posts %}
            {% set author = users[post.userId] %}
            <li id="post-{{ post.id }}" class="thread-post thread-post-{{ post.id }} media">
                <a href="{{ path('user_show', {id:author.id}) }}" class="pull-left user-avatar">
                  <img class="media-object" src="{{ default_path('avatar', author.smallAvatar, '') }}" >
                </a>
                <div class="media-body">
                  <div class="metas">
                    {% include 'TopxiaWebBundle:Thread:post-manage-menu.html.twig' %}
                    <a href="{{ path('user_show', {id:author.id}) }}" class="nickname">{{ author.nickname }}</a>
                    <span class="bullet">•</span>
                    <span class="text-muted">{{post.createdTime|smart_time}} </span>
                  </div>
                  <div class="thread-post-content">{{ post.content|at(post.ats)|raw }}</div>
                  <div>
                    {% include 'TopxiaWebBundle:Thread:post-interaction.html.twig' %}
                  </div>
                  <div class="thread-subpost-container clearfix {% if not post.subposts %}hide{% endif %}">
                    {{ render(controller('TopxiaWebBundle:Article:subposts', {targetId: post.threadId, postId:post.id, less:true})) }}
                    <div class="thread-subpost-morebar clearfix {% if not post.subposts %}hide{% endif %}">
                      {% if service.canAccess('post.create', post) %}
                        <button class="btn btn-default btn-xs pull-right js-toggle-subpost-form">我也说一句</button>
                      {% endif %}
                      <span class="thread-subpost-moretext {% if post.subposts <= 5 %}hide{% endif %}"><span class="text-muted">还有{{ post.subposts - 5 }}条回复，</span><a href="javascript:;" class="js-post-more">点击查看</a></span>
                    </div>

                    {% if service.canAccess('post.create', post) %}
                      <form method="post" action="{{ path('thread_post_reply', {postId:post.id, threadId:0}) }}" class="thread-subpost-form {% if post.subposts %}hide{% endif %}">
                        <input type="hidden" name="targetId" value="{{ post.targetId }}">
                        <input type="hidden" name="targetType" value="article">
                        <div class="form-group">
                          <div class="controls">
                            <textarea class="form-control" name="content" data-display="内容"></textarea>
                          </div>
                        </div>
                        <div class="form-group">
                          <input type="hidden" name="_csrf_token" value="{{ csrf_token('site') }}">
                          <button type="submit" data-loading-text="正在发表" class="btn btn-primary btn-sm pull-right">发表</button>
                        </div>
                      </form>
                    {% endif %}

                  </div>
                </div>
              </li>
          {% else %}
            <li class="empty">一个回复都没有！</li>
          {% endfor %}
        </ul>

        {{ web_macro.paginator(paginator) }}
      </div>
    </div>
  </div>
{% endblock %}

{% block article_side %}
  {{ render(controller('TopxiaWebBundle:Article:popularArticlesBlock')) }}
  {{ render(controller('TopxiaWebBundle:Article:recommendArticlesBlock')) }}
{% endblock %}