{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/download/index.js"],"names":["DownLoad","$form","$","validator2","initStep2Form","bindEvent","validate","rules","title","required","maxlength","trim","link","materials","messages","data","on","itemDelete","event","videoImport","addFileBtn","$parent","currentTarget","closest","mediaId","items","isEmpty","val","JSON","parse","stringify","siblings","length","remove","state","addFile","addToList","hide","valid","source","id","name","summary","size","text","media","Translator","trans","show","setTimeout","slideUp","item_tpl","append","tooltip","removeClass","form","_inItStep2form","obj","undefined","Object","keys","fileSelect","file","fileChooser"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import FileChooser from '../../file-chooser/file-choose';\nimport notify from 'common/notify';\nimport { chooserUiOpen } from '../widget/chooser-ui.js';\n\nclass DownLoad {\n  constructor() {\n    this.$form = $('#step2-form');\n    this.validator2 = null;\n    this.initStep2Form();\n    this.bindEvent();\n  }\n  initStep2Form() {\n    let validator2 = this.$form.validate({\n      rules: {\n        title: {\n          required: true,\n          maxlength: 50,\n          trim: true,\n        },\n        link: 'url',\n        materials: 'required',\n      },\n      messages: {\n        link: \"链接地址不正确\",\n        materials: '请上传或选择%display%'\n      }\n    });\n    this.$form.data('validator', validator2);\n  }\n\n  bindEvent() {\n    this.$form.on('click', '.js-btn-delete', () => this.itemDelete(event));\n    this.$form.on('click', '.js-video-import', () => this.videoImport(false));\n    this.$form.on('click', '.js-add-file-list', () => this.addFileBtn(true));\n  }\n\n  itemDelete(event) {\n    let $parent = $(event.currentTarget).closest('li');\n    let mediaId = $parent.data('id');\n    let items = isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n    if (items && items[mediaId]) {\n      delete items[mediaId];\n      $(\"#materials\").val(JSON.stringify(items));\n    }\n    if ($parent.siblings('li').length <= 0) {\n      $(\"#materials\").val(null);\n    }\n    $parent.remove();\n  }\n\n  videoImport(state) {\n    this.addFile(state);\n  }\n\n  addFile(addToList) {\n    $('.js-success-redmine').hide();\n    if (isEmpty($(\"#media\").val()) && $(\"#step2-form\").data('validator') && $(\"#step2-form\").data('validator').valid() && $(\"#link\").val().length > 0) {\n      if (!addToList) {\n        $(\"#verifyLink\").val($(\"#link\").val());\n      }\n      let data = {\n        source: 'link',\n        id: $(\"#verifyLink\").val(),\n        name: $(\"#verifyLink\").val(),\n        link: $(\"#verifyLink\").val(),\n        summary: $(\"#file-summary\").val(),\n        size: 0\n      };\n      $('.js-current-file').text($(\"#verifyLink\").val());\n      $(\"#media\").val(JSON.stringify(data));\n    }\n\n\n    let media = isEmpty($(\"#media\").val()) ? {} : JSON.parse($(\"#media\").val());\n    let items = isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n\n    if (!isEmpty(items) && items[media.id]) {\n      $('.js-danger-redmine').text(Translator.trans('该文件已添加，请重新选择')).show();\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      $('.js-current-file').text('');\n      $(\"#media\").val(null);\n      media = null;\n      return;\n    }\n\n    if (!addToList) {\n      return;\n    }\n\n    if (addToList && isEmpty(media)) {\n      $('.js-danger-redmine').text(Translator.trans('请上传或选择要添加的资料')).show();\n      $('.js-current-file').text('');\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      return;\n    }\n\n\n    $('.js-current-file').text('');\n    media.summary = $(\"#file-summary\").val();\n    items[media.id] = media;\n    $(\"#materials\").val(JSON.stringify(items));\n\n    $(\"#media\").val(null);\n    $('#link').val(null);\n    $(\"#file-summary\").val(null);\n\n\n    let item_tpl = '';\n    if (media.link) {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.link}\">\n        <a class=\"gray-primary\" href=\"${ media.link}\" target=\"_blank\">${media.name}</a>\n        <a class=\"gray-primary phm btn-delete  js-btn-delete\"  href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"{{ '删除'|trans }}\"><i class=\"es-icon es-icon-delete\"></i></a>\n        <span class=\"glyphicon glyphicon-new-window text-muted text-sm\" title=\"${Translator.trans('删除')}\"></span>\n    </li>\n  `;\n    } else {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.id}\">\n      <a class=\"gray-primary\" href=\"/materiallib/${ media.id}/download\">${media.name}</a>\n      <a class=\"gray-primary phm  btn-delete js-btn-delete\" href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"${Translator.trans('删除')}\"><i class=\"es-icon es-icon-delete\"></i></a>\n    </li>\n  `;\n    }\n    $(\"#material-list\").append(item_tpl);\n    $('[data-toggle=\"tooltip\"]').tooltip();\n    $('.file-browser-item').removeClass('active');\n    $('.js-danger-redmine').hide();\n    $('.js-success-redmine').text(Translator.trans('添加成功，可继续选择资料添加或点击下一步！')).show();\n    setTimeout(function () {\n      $('.js-success-redmine').slideUp();\n    }, 3000);\n    if ($('.jq-validate-error:visible').length > 0) {\n      $(\"#step2-form\").data('validator').form();\n    }\n  }\n}\n\n\n\n\n// $('#step2-form').on('click', '.js-btn-delete', function () {\n//   let $parent = $(this).parents('li');\n//   let mediaId = $parent.data('id');\n//   let items = isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n//   if (items && items[mediaId]) {\n//     delete items[mediaId];\n//     $(\"#materials\").val(JSON.stringify(items));\n//   }\n//   if ($parent.siblings('li').length <= 0) {\n//     $(\"#materials\").val(null);\n//   }\n//   $parent.remove();\n// })\n\n$('#step2-form').on('click', '.js-video-import', function () {\n  addFile(false);\n})\n\n$('#step2-form').on('click', '.js-add-file-list', function () {\n  addFile(true);\n})\n\n// function addFile(addToList) {\n//   $('.js-success-redmine').hide();\n//   if (isEmpty($(\"#media\").val()) && $(\"#step2-form\").data('validator') && $(\"#step2-form\").data('validator').valid() && $(\"#link\").val().length > 0) {\n//     if (!addToList) {\n//       $(\"#verifyLink\").val($(\"#link\").val());\n//     }\n//     let data = {\n//       source: 'link',\n//       id: $(\"#verifyLink\").val(),\n//       name: $(\"#verifyLink\").val(),\n//       link: $(\"#verifyLink\").val(),\n//       summary: $(\"#file-summary\").val(),\n//       size: 0\n//     };\n//     $('.js-current-file').text($(\"#verifyLink\").val());\n//     $(\"#media\").val(JSON.stringify(data));\n//   }\n\n\n//   let media = isEmpty($(\"#media\").val()) ? {} : JSON.parse($(\"#media\").val());\n//   let items = isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n\n//   if (!isEmpty(items) && items[media.id]) {\n//     $('.js-danger-redmine').text(Translator.trans('该文件已添加，请重新选择')).show();\n//     setTimeout(function () {\n//       $('.js-danger-redmine').slideUp();\n//     }, 3000);\n//     $('.js-current-file').text('');\n//     $(\"#media\").val(null);\n//     media = null;\n//     return;\n//   }\n\n//   if (!addToList) {\n//     return;\n//   }\n\n//   if (addToList && isEmpty(media)) {\n//     $('.js-danger-redmine').text(Translator.trans('请上传或选择要添加的资料')).show();\n//     $('.js-current-file').text('');\n//     setTimeout(function () {\n//       $('.js-danger-redmine').slideUp();\n//     }, 3000);\n//     return;\n//   }\n\n\n//   $('.js-current-file').text('');\n//   media.summary = $(\"#file-summary\").val();\n//   items[media.id] = media;\n//   $(\"#materials\").val(JSON.stringify(items));\n\n//   $(\"#media\").val(null);\n//   $('#link').val(null);\n//   $(\"#file-summary\").val(null);\n\n\n//   let item_tpl = '';\n//   if (media.link) {\n//     item_tpl = `\n//     <li class=\"download-item \" data-id=\"${media.link}\">\n//         <a class=\"gray-primary\" href=\"${ media.link}\" target=\"_blank\">${media.name}</a>\n//         <a class=\"gray-primary phm btn-delete  js-btn-delete\"  href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"{{ '删除'|trans }}\"><i class=\"es-icon es-icon-delete\"></i></a>\n//         <span class=\"glyphicon glyphicon-new-window text-muted text-sm\" title=\"${Translator.trans('删除')}\"></span>\n//     </li>\n//   `;\n//   } else {\n//     item_tpl = `\n//     <li class=\"download-item \" data-id=\"${media.id}\">\n//       <a class=\"gray-primary\" href=\"/materiallib/${ media.id}/download\">${media.name}</a>\n//       <a class=\"gray-primary phm  btn-delete js-btn-delete\" href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"${Translator.trans('删除')}\"><i class=\"es-icon es-icon-delete\"></i></a>\n//     </li>\n//   `;\n//   }\n//   $(\"#material-list\").append(item_tpl);\n//   $('[data-toggle=\"tooltip\"]').tooltip();\n//   $('.file-browser-item').removeClass('active');\n//   $('.js-danger-redmine').hide();\n//   $('.js-success-redmine').text(Translator.trans('添加成功，可继续选择资料添加或点击下一步！')).show();\n//   setTimeout(function () {\n//     $('.js-success-redmine').slideUp();\n//   }, 3000);\n//   if ($('.jq-validate-error:visible').length > 0) {\n//     $(\"#step2-form\").data('validator').form();\n//   }\n// }\n\n_inItStep2form();\n\n\nfunction isEmpty(obj) {\n  return obj == null || obj == \"\" || obj == undefined || Object.keys(obj).length == 0;\n}\nconst fileSelect = file => {\n  $(\"input[name=media]\").val(JSON.stringify(file));\n  chooserUiOpen();\n  addFile(false);\n  $('.js-current-file').text(file.name);\n}\n\nconst fileChooser = new FileChooser();\n\nfileChooser.on('select', fileSelect);"]}