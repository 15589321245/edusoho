{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/download/download.js"],"names":["DownLoad","$form","$","validator2","firstName","val","initStep2Form","bindEvent","initFileChooser","validate","rules","title","required","maxlength","trim","link","materials","messages","data","on","itemDelete","event","videoImport","addFileBtn","$parent","currentTarget","closest","mediaId","items","isEmpty","JSON","parse","stringify","siblings","length","remove","state","addFile","fileSelect","file","text","name","fileChooser","obj","undefined","Object","keys","addToList","hide","valid","source","id","summary","size","media","Translator","trans","show","setTimeout","slideUp","item_tpl","append","tooltip","removeClass","form"],"mappings":"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","file":"download.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import FileChooser from '../../file-chooser/file-choose';\nimport notify from 'common/notify';\nimport { chooserUiOpen } from '../widget/chooser-ui.js';\n\nexport default class DownLoad {\n  constructor() {\n    this.$form = $('#step2-form');\n    this.validator2 = null;\n    this.firstName = $('#title').val();\n    this.initStep2Form();\n    this.bindEvent();\n    this.initFileChooser();\n  }\n  initStep2Form() {\n    let validator2 = this.$form.validate({\n      rules: {\n        title: {\n          required: true,\n          maxlength: 50,\n          trim: true,\n        },\n        link: 'url',\n        materials: 'required',\n      },\n      messages: {\n        link: \"链接地址不正确\",\n        materials: '请上传或选择%display%'\n      }\n    });\n    this.$form.data('validator', validator2);\n  }\n\n  bindEvent() {\n    this.$form.on('click', '.js-btn-delete', () => this.itemDelete(event));\n    this.$form.on('click', '.js-video-import', () => this.videoImport(false));\n    this.$form.on('click', '.js-add-file-list', () => this.addFileBtn(true));\n  }\n\n  itemDelete(event) {\n    let $parent = $(event.currentTarget).closest('li');\n    let mediaId = $parent.data('id');\n    let items = this.isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n    if (items && items[mediaId]) {\n      delete items[mediaId];\n      $(\"#materials\").val(JSON.stringify(items));\n    }\n    if ($parent.siblings('li').length <= 0) {\n      $(\"#materials\").val(null);\n    }\n    $parent.remove();\n  }\n\n  videoImport(state) {\n    this.addFile(state);\n  }\n\n  addFileBtn(state) {\n    this.addFile(state);\n  }\n\n  initFileChooser() {\n    const fileSelect = file => {\n      $(\"input[name=media]\").val(JSON.stringify(file));\n      chooserUiOpen();\n      this.addFile(false);\n      if(this.firstName) {\n        $('#title').val(this.firstName);\n      }\n      $('.js-current-file').text(file.name);\n    }\n\n    const fileChooser = new FileChooser();\n\n    fileChooser.on('select', fileSelect);\n  }\n\n  isEmpty(obj) {\n    return obj == null || obj == \"\" || obj == undefined || Object.keys(obj).length == 0;\n  }\n\n  addFile(addToList) {\n    //@TODO重构代码\n    $('.js-success-redmine').hide();\n    if (this.isEmpty($(\"#media\").val()) && $(\"#step2-form\").data('validator') && $(\"#step2-form\").data('validator').valid() && $(\"#link\").val().length > 0) {\n      if (!addToList) {\n        $(\"#verifyLink\").val($(\"#link\").val());\n      }\n      let data = {\n        source: 'link',\n        id: $(\"#verifyLink\").val(),\n        name: $(\"#verifyLink\").val(),\n        link: $(\"#verifyLink\").val(),\n        summary: $(\"#file-summary\").val(),\n        size: 0\n      };\n      $('.js-current-file').text($(\"#verifyLink\").val());\n      $(\"#media\").val(JSON.stringify(data));\n    }\n\n\n    let media = this.isEmpty($(\"#media\").val()) ? {} : JSON.parse($(\"#media\").val());\n    let items = this.isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n\n    if (!this.isEmpty(items) && items[media.id]) {\n      $('.js-danger-redmine').text(Translator.trans('该文件已添加，请重新选择')).show();\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      $('.js-current-file').text('');\n      $(\"#media\").val(null);\n      media = null;\n      return;\n    }\n\n    if (!addToList) {\n      return;\n    }\n\n    if (addToList && this.isEmpty(media)) {\n      $('.js-danger-redmine').text(Translator.trans('请上传或选择要添加的资料')).show();\n      $('.js-current-file').text('');\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      return;\n    }\n\n\n    $('.js-current-file').text('');\n    media.summary = $(\"#file-summary\").val();\n    items[media.id] = media;\n    $(\"#materials\").val(JSON.stringify(items));\n\n    $(\"#media\").val(null);\n    $('#link').val(null);\n    $(\"#file-summary\").val(null);\n\n    if(!this.firstName) {\n       this.firstName = media.name;\n       $('#title').val(media.name);\n    }\n  \n\n    let item_tpl = '';\n    if (media.link) {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.link}\">\n        <a class=\"gray-primary\" href=\"${ media.link}\" target=\"_blank\">${media.name}</a>\n        <a class=\"gray-primary phm btn-delete  js-btn-delete\"  href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"{{ '删除'|trans }}\"><i class=\"es-icon es-icon-delete\"></i></a>\n        <span class=\"glyphicon glyphicon-new-window text-muted text-sm\" title=\"${Translator.trans('删除')}\"></span>\n    </li>\n  `;\n    } else {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.id}\">\n      <a class=\"gray-primary\" href=\"/materiallib/${ media.id}/download\">${media.name}</a>\n      <a class=\"gray-primary phm  btn-delete js-btn-delete\" href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"${Translator.trans('删除')}\"><i class=\"es-icon es-icon-delete\"></i></a>\n    </li>\n  `;\n    }\n    $(\"#material-list\").append(item_tpl);\n    $('[data-toggle=\"tooltip\"]').tooltip();\n    $('.file-browser-item').removeClass('active');\n    $('.js-danger-redmine').hide();\n    $('.js-success-redmine').text(Translator.trans('添加成功，可继续选择资料添加或点击下一步！')).show();\n    setTimeout(function () {\n      $('.js-success-redmine').slideUp();\n    }, 3000);\n    if ($('.jq-validate-error:visible').length > 0) {\n      $(\"#step2-form\").data('validator').form();\n    }\n  }\n}"]}