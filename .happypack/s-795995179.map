{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/download/download.js"],"names":["DownLoad","$element","$form","validator2","initStep2Form","bindEvent","initFileChooser","validate","rules","title","required","maxlength","trim","link","materials","messages","data","on","itemDelete","event","videoImport","addFileBtn","$parent","$","currentTarget","closest","mediaId","items","isEmpty","val","JSON","parse","stringify","siblings","length","remove","state","addFile","fileSelect","file","text","name","fileChooser","obj","undefined","Object","keys","addToList","hide","valid","source","id","summary","size","media","Translator","trans","show","setTimeout","slideUp","item_tpl","append","tooltip","removeClass","form"],"mappings":"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","file":"download.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import FileChooser from '../../file-chooser/file-choose';\nimport notify from 'common/notify';\nimport { chooserUiOpen } from '../widget/chooser-ui.js';\n\nclass DownLoad {\n  constructor($element) {\n    this.$form = $element;\n    this.validator2 = null;\n    this.initStep2Form();\n    this.bindEvent();\n    this.initFileChooser();\n  }\n  initStep2Form() {\n    let validator2 = this.$form.validate({\n      rules: {\n        title: {\n          required: true,\n          maxlength: 50,\n          trim: true,\n        },\n        link: 'url',\n        materials: 'required',\n      },\n      messages: {\n        link: \"链接地址不正确\",\n        materials: '请上传或选择%display%'\n      }\n    });\n    this.$form.data('validator', validator2);\n  }\n\n  bindEvent() {\n    this.$form.on('click', '.js-btn-delete', () => this.itemDelete(event));\n    this.$form.on('click', '.js-video-import', () => this.videoImport(false));\n    this.$form.on('click', '.js-add-file-list', () => this.addFileBtn(true));\n  }\n\n  itemDelete(event) {\n    let $parent = $(event.currentTarget).closest('li');\n    let mediaId = $parent.data('id');\n    let items = this.isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n    if (items && items[mediaId]) {\n      delete items[mediaId];\n      $(\"#materials\").val(JSON.stringify(items));\n    }\n    if ($parent.siblings('li').length <= 0) {\n      $(\"#materials\").val(null);\n    }\n    $parent.remove();\n  }\n\n  videoImport(state) {\n    this.addFile(state);\n  }\n\n  addFileBtn(state) {\n    this.addFile(state);\n  }\n\n  initFileChooser() {\n    const fileSelect = file => {\n      $(\"input[name=media]\").val(JSON.stringify(file));\n      chooserUiOpen();\n      this.addFile(false);\n      $('.js-current-file').text(file.name);\n    }\n\n    const fileChooser = new FileChooser();\n\n    fileChooser.on('select', fileSelect);\n  }\n\n  isEmpty(obj) {\n    return obj == null || obj == \"\" || obj == undefined || Object.keys(obj).length == 0;\n  }\n\n  addFile(addToList) {\n    //@TODO重构代码\n    $('.js-success-redmine').hide();\n    if (this.isEmpty($(\"#media\").val()) && $(\"#step2-form\").data('validator') && $(\"#step2-form\").data('validator').valid() && $(\"#link\").val().length > 0) {\n      if (!addToList) {\n        $(\"#verifyLink\").val($(\"#link\").val());\n      }\n      let data = {\n        source: 'link',\n        id: $(\"#verifyLink\").val(),\n        name: $(\"#verifyLink\").val(),\n        link: $(\"#verifyLink\").val(),\n        summary: $(\"#file-summary\").val(),\n        size: 0\n      };\n      $('.js-current-file').text($(\"#verifyLink\").val());\n      $(\"#media\").val(JSON.stringify(data));\n    }\n\n\n    let media = this.isEmpty($(\"#media\").val()) ? {} : JSON.parse($(\"#media\").val());\n    let items = this.isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n\n    if (!this.isEmpty(items) && items[media.id]) {\n      $('.js-danger-redmine').text(Translator.trans('该文件已添加，请重新选择')).show();\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      $('.js-current-file').text('');\n      $(\"#media\").val(null);\n      media = null;\n      return;\n    }\n\n    if (!addToList) {\n      return;\n    }\n\n    if (addToList && this.isEmpty(media)) {\n      $('.js-danger-redmine').text(Translator.trans('请上传或选择要添加的资料')).show();\n      $('.js-current-file').text('');\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      return;\n    }\n\n\n    $('.js-current-file').text('');\n    media.summary = $(\"#file-summary\").val();\n    items[media.id] = media;\n    $(\"#materials\").val(JSON.stringify(items));\n\n    $(\"#media\").val(null);\n    $('#link').val(null);\n    $(\"#file-summary\").val(null);\n\n\n    let item_tpl = '';\n    if (media.link) {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.link}\">\n        <a class=\"gray-primary\" href=\"${ media.link}\" target=\"_blank\">${media.name}</a>\n        <a class=\"gray-primary phm btn-delete  js-btn-delete\"  href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"{{ '删除'|trans }}\"><i class=\"es-icon es-icon-delete\"></i></a>\n        <span class=\"glyphicon glyphicon-new-window text-muted text-sm\" title=\"${Translator.trans('删除')}\"></span>\n    </li>\n  `;\n    } else {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.id}\">\n      <a class=\"gray-primary\" href=\"/materiallib/${ media.id}/download\">${media.name}</a>\n      <a class=\"gray-primary phm  btn-delete js-btn-delete\" href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"${Translator.trans('删除')}\"><i class=\"es-icon es-icon-delete\"></i></a>\n    </li>\n  `;\n    }\n    $(\"#material-list\").append(item_tpl);\n    $('[data-toggle=\"tooltip\"]').tooltip();\n    $('.file-browser-item').removeClass('active');\n    $('.js-danger-redmine').hide();\n    $('.js-success-redmine').text(Translator.trans('添加成功，可继续选择资料添加或点击下一步！')).show();\n    setTimeout(function () {\n      $('.js-success-redmine').slideUp();\n    }, 3000);\n    if ($('.jq-validate-error:visible').length > 0) {\n      $(\"#step2-form\").data('validator').form();\n    }\n  }\n}"]}