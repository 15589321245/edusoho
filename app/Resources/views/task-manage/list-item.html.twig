{% set chapter = task %}
<li class="task-manage-item js-task-manage-item drag clearfix " id="chapter-{{ chapter.id }}">
  {% set tasks = array_index(chapter.tasks, 'mode') %}
  {% set task = tasks.lesson|default(null) %}
  <div class="item-line"></div>
  <div class="item-content  js-item-content text-overflow">
    <i
      class="es-icon {% if activity_metas(task.activity.mediaType) %}    {{ activity_metas(task.activity.mediaType).icon }}  {% endif %} mrm"></i>
    {% if task.isOptional %}<span class="label label-success mrm">选修</span>{% endif %}
    </i>第<span class="number">{{ chapter.number }}</span>课时： {{ task.title }}  {% if task.status != 'published' %}<span
      class="color-warning"> (未发布)</span> {% endif %}
    {% if task.activity.mediaType is same as('live') %}
      {% if task.activity.endTime < date().timestamp %}
        <span class="text-muted">{{ '已结束'|trans }}</span>
      {% else %}
        <span class="color-success mls">
        {{ task.activity.startTime|date('Y-n-j H:i'|trans) }} ~ {{ task.activity.endTime|date('H:i'|trans) }}</span>
      {% endif %}
    {% else %}
      {% if task.activity.length|activity_length_format %}<span class="color-gray mls">
        （{{ task.activity.length|activity_length_format }}）</span>{% endif %}
    {% endif %}
  </div>
  <div class="item-actions">
    <a class="btn btn-gray" data-role='update-task' href="javascript:;" data-toggle="modal" data-target="#modal"
      data-url="{{ path('course_manage_task_update', {id:task.id,courseId:task.courseId, type:'lesson'}) }}"><i
        class="es-icon es-icon-edit mrs"></i>编辑</a>
    <a class="btn btn-gray" href="{{ path('course_task_show', {id:task.id,courseId:task.courseId,preview:1}) }}"
      target="_blank"><i class="es-icon es-icon-removeredeye mrs"></i>预览</a>
    <span class="dropdown">
      <a class="dropdown-toggle dropdown-more btn btn-gray" id="dropdown-more" data-toggle="dropdown" href="#">
        <i class="es-icon es-icon-keyboardarrowdown mrs" aria-haspopup="true" aria-expanded="false"></i>{{ '更多'|trans }}
      </a>
      <ul class="dropdown-menu pull-right dropdown-menu-more" role="menu" style="margin-top:12px;min-width:144px"
        aria-labelledby="dLabel" style="display:none;">
        {% if task.status|default('create') == 'published' %}
          <li>
          <a class='unpublish-item' href="javascript:;" data-type="task"
            data-url="{{ path('course_manage_task_unpublish', {id:task.id,courseId:task.courseId}) }}">
             <i class="es-icon es-icon-close01 mrm"></i>取消发布
           </a>
        </li>
        {% else %}
          <li>
            <a class='publish-item' href="javascript:;" data-type="task"
              data-url="{{ path('course_manage_task_publish', {id:task.id,courseId:task.courseId}) }}">
               <i class="es-icon es-icon--check-circle mrm"></i>发布
             </a>
          </li>
          <li>
          <a class='delete-item' href="javascript:;" data-type="task"
            data-url="{{ path('course_manage_task_delete', {taskId:task.id,courseId:task.courseId}) }}">
            <i class="es-icon es-icon-delete mrm"></i>删除
          </a>
        </li>
        {% endif %}
        {# 直播课时结束后 #}
        {% if task.activity.mediaType is same as('live') and task.activity.endTime < date().timestamp %}
          {% set live = task.activity.ext %}
          {% set replayStatus = live.replayStatus|default('ungenerated') %}

          {# 未生成回放 #}
          {% if replayStatus == 'ungenerated' and live_can_record(live.liveId) %}
            <li>
              <a class='js-generate-replay' href="javascript:;" data-type="task"
                data-url="{{ path('course_manage_task_replay_create', {courseId:task.courseId, taskId:task.id}) }}">
                 <i class="glyphicon glyphicon-facetime-video mrm"></i>录制
              </a>
            </li>
          {# 已生成录制 #}
          {% elseif replayStatus == 'generated' %}
            <li>
              <a class='js-edit-replay' href="javascript:;" data-type="task"
                data-url="{{ path('course_manage_task_replay_edit',{ courseId: task.courseId, taskId:task.id}) }}">
                 <i class="es-icon es-icon--check-circle mrm"></i>编辑录制
              </a>
            </li>
          {% endif %}

          <li>
            <a class='js-upload-replay' href="javascript:;" data-type="task"
              data-url="{{ path('course_manage_task_replay_upload', {courseId: task.courseId, taskId:task.id}) }}">
              <i class="glyphicon glyphicon-paperclip mrm"></i>上传回放
            </a>
          </li>
        {% endif %}
      </ul>
    </span>
  </div>
  <div class="settings-list js-settings-list clearfix">
    <div class="settings-item {% if tasks.preparation|default(null) %} active {% endif %}">
      <a href="javascript:;" data-toggle="modal" data-target="#modal" data-backdrop="static" data-keyboard="false"
        {% if not tasks.preparation|default(null) %}
        data-url="{{ path('course_manage_task_create', {courseId:course.id, type: 'preparation', categoryId: chapter.id}) }}">
        {% else %}
          data-url="{{ path('course_manage_task_update', {id:tasks.preparation.id,courseId:tasks.preparation.courseId, type:'preparation', categoryId: chapter.id}) }}">
        {% endif %}
        <i class="es-icon es-icon-yulan mrm"></i>
        预习
      </a>
      <i class="es-icon es-icon-angledoubleright after"></i>
    </div>
    <div class="settings-item js-settings-item active">
      <a href="javascript:;">
        <i class="es-icon es-icon-book mrm"></i>
        课时学习
      </a>
      <i class="es-icon es-icon-angledoubleright after"></i>
    </div>
    <div class="settings-item {% if tasks.exercise|default(null) %} active {% endif %}">
      <a href="javascript:;" data-toggle="modal" data-target="#modal" data-backdrop="static" data-keyboard="false"
        {% if not tasks.exercise|default(null) %}
        data-url="{{ path('course_manage_task_create', {courseId:course.id, type: 'exercise', categoryId: chapter.id}) }}">
        {% else %}
          data-url="{{ path('course_manage_task_update', {id:tasks.exercise.id,courseId:tasks.exercise.courseId, type:'exercise', categoryId: chapter.id}) }}">
        {% endif %}
        <i class="es-icon es-icon-exam mrm"></i>
        练习
      </a>
      <i class="es-icon es-icon-angledoubleright after"></i>
    </div>
    <div class="settings-item {% if tasks.homework|default(null) %} active {% endif %}">
      <a href="javascript:;" data-toggle="modal" data-target="#modal" data-backdrop="static" data-keyboard="false"
        {% if not tasks.homework|default(null) %}
        data-url="{{ path('course_manage_task_create', {courseId:course.id, type: 'homework', categoryId: chapter.id}) }}">
        {% else %}
          data-url="{{ path('course_manage_task_update', {id:tasks.homework.id,courseId:tasks.homework.courseId, type:'homework', categoryId: chapter.id}) }}">
        {% endif %}
        <i class="es-icon es-icon-mylibrarybooks mrm"></i>
        作业
      </a>
      <i class="es-icon es-icon-angledoubleright after"></i>
    </div>
    <div class="settings-item {% if tasks.extraClass|default(null) %} active {% endif %}">
      <a href="javascript:;" data-toggle="modal" data-target="#modal" data-backdrop="static" data-keyboard="false"
        {% if not  tasks.extraClass|default(null) %}
        data-url="{{ path('course_manage_task_create', {courseId:course.id, type: 'extraClass', categoryId: chapter.id}) }}">
        {% else %}
          data-url="{{ path('course_manage_task_update', {id:tasks.extraClass.id,courseId:tasks.extraClass.courseId, type:'extraClass', categoryId: chapter.id}) }}">
        {% endif %}
        <i class="es-icon es-icon-sun mrm"></i>
        课外
      </a>
    </div>
  </div>
</li>