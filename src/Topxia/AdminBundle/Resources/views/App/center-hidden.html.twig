{% extends 'TopxiaAdminBundle::layout.html.twig' %}

{% set menu = 'admin_app_center' %}

{% set script_controller = 'app/center' %}
  
{% block main %}

  <div class="mbl btn-group">

      <a href="{{ url('admin_app_center', {postStatus: 'all' }) }}" type="button" class="btn btn-default btn-sm {% if type == 'all' %} btn-primary{% endif %}">全部</a>

      <a href=" {{ url('admin_app_center', {postStatus: 'theme' }) }}" type="button" class="btn btn-default btn-sm {% if type == 'theme' %}btn-primary{% endif %}">主题</a>

      <a href=" {{ url('admin_app_center', {postStatus: 'app' }) }}" type="button" class="btn btn-default btn-sm {% if type == 'app' %}btn-primary{% endif %}">应用</a>
  </div>


  <div class="checkbox-group appTypeChoices" RepeatDirection="Horizontal" id="appTypeChoices" name="appTypeChoices" style="float:right;margin-top:-45px;">
      <div class="sortedCourses">
      <input type="checkbox" name="appTypeChoices" id="installedApps" 
         value="installedApps" data-url="{{path('admin_app_center',{postStatus: type })}}" {% if appTypeChoices|default(null)  == 'installedApps' %} checked{% endif %} >
         隐藏已购应用
       <input type="hidden" name="type" value= '{{type}}' id="type">
      </div>
  </div>


  {% if status|default(null) == 'error' %}
    <div class="alert alert-danger">AccessKey或者SecretKey设置不正确，会影响到系统正常的运行，<a href="{{path('admin_setting_cloud')}}">请修改设置。</a></div>
  {% elseif  status|default(null) == 'unlink' %}
    <div class="alert alert-danger">您的服务器无法连接到更新服务器，请检查网络连接状况。</div>
  {% else %}

  <table class="table table-striped table-hover" id="app-table-container">
    <thead>

    </thead>
    <tbody>

      {% if type == 'all' %}
      {% set apps = apps %}
      {% elseif type == 'theme'%}
      {% set apps = theme %}
      {% elseif type == 'app' %}
      {% set apps = allApp %}
      {% endif  %}

      {% for app in apps %}
        {% set installedApp = installedApps[app.code]|default(null) %}
           {% if app.purchased|default(false) == true or installedApp %}
              
              {% else %}
      <tr>
        <td>
          <img src="http://open.edusoho.com/files/product/{{ app.icon }}" class="app-img pull-left mrl mtm"/>

          <div class="mtm">
            <a target="_blank" href="http://open.edusoho.com/app/{{ app.code }}">
              <h4><strong class="text-primary">{{ app.name }}</strong>            
              {% if app.licensed %}
              <span class="label label-success mls">商业版</span>
              {% endif %}
              </h4>
            </a>
          </div>
          
          <div class="info mtm mbm clearfix">

            <div class="left-info pull-left">
              <div class="text-muted">作者： {{ app.developerName }}</div>
              <div class="mts text-muted">{% if app.type == "theme" %}主题{% else %}应用{% endif %}
              </div>
              <div class="class-rating mtm">
              {% if app.comment|default(null) %}
                {% set comment = app.comment%}
                <span class="stars-{{ comment.rating|number_format }}">&nbsp;</span>
                <span class="text-muted">{{ comment.commenters|default(0) }}个评价</span>
              {% else %}
                <span class="stars-0">&nbsp;</span>
                <span class="text-muted">0个评价</span>
              {% endif %}
            </div>
            </div>

            <div class="middle-info pull-left short-long-text">
              <div class="short-text text-muted">{{ app.description|plain_text(80) }} <span class="trigger">(展开)</span></div>
              <div class="long-text text-muted">{{ app.description|raw }} <span class="trigger">(收起)</span></div>
            </div>

            <div class="right-info pull-right">
              {% if app.price == 0 and not app.licensed %}
                 <a href="#" data-toggle="modal" data-target="#modal" data-url="{{ path('admin_app_package_update_modal', {id:app.latestPackageId, type:'install'})}}" class="btn btn-primary app-btn" data-keyboard="false" data-backdrop="static">安装</a>
              {% else %}
                 <a href="http://open.edusoho.com/app/{{ app.code }}" class="btn btn-warning app-btn" target="_blank">购买</a>
              {% endif %}
                <p class="mtm"><span class="text-muted">价格：</sapn><span class="price"> ¥ {% if app.price > 0 %}{{ app.price}}{% else %}免费{% endif %}</sapn></p>
            </div>

          </div> 
          
         <!--  
         <div class="text-muted"><small>最后更新： {{ app.latestTime|date('Y-m-d') }}</small></div> -->
        </td>
      </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

{% endblock %}