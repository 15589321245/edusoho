{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/download/index.js"],"names":["jQuery","validator","addMethod","value","element","optional","test","_inItStep2form","$form","$","validate","rules","title","required","maxlength","link","materials","messages","data","on","$parent","parents","mediaId","items","isEmpty","val","JSON","parse","stringify","siblings","length","remove","addFile","addToList","valid","source","id","name","summary","size","text","media","item_tpl","append","form","obj","undefined","Object","keys","fileSelect","file","fileChooser"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import FileChooser from '../../file-chooser/file-choose';\nimport notify from 'common/notify';\nimport {chooserUiOpen, chooserUiClose, showChooserType} from '../widget/chooser-ui.js';\njQuery.validator.addMethod(\"url\", function (value, element) {\n  return this.optional(element) || /^(http|https):\\/\\/(\\w+:{0,1}\\w*@)?(\\S+)(:[0-9]+)?(\\/|\\/([\\w#!:.?+=&%@!\\-\\/]))?$/.test(value);\n}, \"URL的格式不正确\");\n\n// showChooserType($(\"input[name=mediaId]\"));\n\n_inItStep2form();\n\nfunction _inItStep2form() {\n  var $form = $('#step2-form');\n  var validator = $form.validate({\n    rules: {\n      title: {\n        required: true,\n        maxlength: 50,\n      },\n      link: 'url',\n      materials: 'required',\n    },\n    messages: {\n      link: \"链接地址不正确\",\n      materials: '请上传或选择%display%'\n    }\n  });\n\n  $form.data('validator', validator);\n}\n\n$('#step2-form').on('click', '.js-btn-delete', function () {\n  let $parent = $(this).parents('li');\n  let mediaId = $parent.data('id');\n  let items = isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n  if (items && items[mediaId]) {\n    delete items[mediaId];\n    $(\"#materials\").val(JSON.stringify(items));\n  }\n  if ($parent.siblings('li').length <= 0) {\n    $(\"#materials\").val(null);\n  }\n  $parent.remove();\n})\n\n$('#step2-form').on('click', '.js-video-import', function () {\n  addFile(false);\n})\n\n$('#step2-form').on('click', '.js-add-file-list', function () {\n  addFile(true);\n})\n\nfunction addFile(addToList) {\n  if (isEmpty($(\"#media\").val()) && $(\"#step2-form\").data('validator') && $(\"#step2-form\").data('validator').valid() && $(\"#link\").val().length > 0) {\n    if (!addToList) {\n      $(\"#verifyLink\").val($(\"#link\").val());\n    }\n    let data = {\n      source: 'link',\n      id: $(\"#verifyLink\").val(),\n      name: $(\"#verifyLink\").val(),\n      link: $(\"#verifyLink\").val(),\n      summary: $(\"#file-summary\").val(),\n      size: 0\n    };\n    $('.js-current-file').text($(\"#verifyLink\").val());\n    $(\"#media\").val(JSON.stringify(data));\n  }\n\n\n  let media = isEmpty($(\"#media\").val()) ? {} : JSON.parse($(\"#media\").val());\n  let items = isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n\n  if (!isEmpty(items) && items[media.id]) {\n    notify('danger', '选择重复');\n    $(\"#media\").val(null);\n    media = null;\n    return;\n  }\n\n  if (!addToList) {\n    return;\n  }\n\n  if (addToList && isEmpty(media)) {\n    notify('danger', '请先选择资料');\n    return;\n  }\n\n\n  $('.js-current-file').text('无');\n\n  media.summary = $(\"#file-summary\").val();\n  items[media.id] = media;\n  $(\"#materials\").val(JSON.stringify(items));\n\n  $(\"#media\").val(null);\n  $('#link').val(null);\n  $(\"#file-summary\").val(null);\n\n\n  let item_tpl = '';\n  if (media.link) {\n    item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.link}\">\n        <a class=\"gray-primary\" href=\"${ media.link }\" target=\"_blank\">${ media.name }</a>\n        <a class=\"gray-primary phm btn-delete  js-btn-delete\"  href=\"javascript:;\"  title=\"{{'删除'|trans}}\" data-url=\"\"><i class=\"es-icon es-icon-cuowu\"></i></a>\n        <span class=\"glyphicon glyphicon-new-window text-muted text-sm\" title=\"{{'网络链接资料'|trans}}\"></span>\n    </li>\n  `;\n  } else {\n    item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.id}\">\n      <a class=\"gray-primary\" href=\"/materiallib/${ media.id }/download\">${ media.name }</a>\n      <a class=\"gray-primary phm  btn-delete js-btn-delete\" href=\"javascript:;\" title=\"{{'删除'|trans}}\" data-url=\"\"><i class=\"es-icon es-icon-cuowu\"></i></a>\n    </li>\n  `;\n  }\n  $(\"#material-list\").append(item_tpl);\n  if ($('.jq-validate-error:visible').length > 0) {\n    $(\"#step2-form\").data('validator').form();\n  }\n}\n\n_inItStep2form();\n\n\nfunction isEmpty(obj) {\n  return obj == null || obj == \"\" || obj == undefined || Object.keys(obj).length == 0;\n}\nconst fileSelect = file => {\n  $(\"input[name=media]\").val(JSON.stringify(file));\n  chooserUiOpen();\n  addFile(false);\n  $('.js-current-file').text(file.name);\n}\n\nconst fileChooser = new FileChooser();\n\nfileChooser.on('select', fileSelect);"]}