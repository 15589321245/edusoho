{"version":3,"sources":["app/Resources/static-src/app/js/testpaper-manage/check/index.js"],"names":["$","validator","addMethod","value","element","isFloat","test","Number","data","format","CheckTest","$container","checkContent","$form","find","$dialog","_initEvent","_init","_initValidate","on","_showEssayInputEditor","event","_submitValidate","_quick2Question","_submit","_teacherSayFill","$shortTextarea","currentTarget","hasClass","preventDefault","stopPropagation","blur","$longTextarea","siblings","$textareaBtn","hide","show","editor","CKEDITOR","replace","attr","toolbar","filebrowserImageUploadUrl","e","updateElement","setTimeout","val","getData","change","focus","one","text","destroy","validate","length","each","index","rules","required","score","min","messages","$target","position","offset","document","scrollTop","top","scoreTotal","undefined","form","self","content","questionId","subjectiveScore","totalScore","html","modal","teacherSay","passedStatus","button","post","result","response","window","location","href","$option"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import QuestionTypeBuilder from '../../testpaper/widget/question-type-builder';\nimport {\n  initScrollbar,\n  testpaperCardFixed,\n  testpaperCardLocation,\n  initWatermark,\n  onlyShowError\n} from 'app/js/testpaper/widget/part';\n$.validator.addMethod(\"score\",function(value,element){ \n  let isFloat = /^\\d+(\\.\\d)?$/.test(value);\n  if (!isFloat){\n    return false;\n  }\n\n  if (Number(value) <= Number($(element).data('score'))) {\n    return true;\n  } else {\n    return false;\n  }\n  \n}, $.validator.format(\"分数只能是<=题目分数、且>=0的整数或者1位小数\"));\n\nclass CheckTest\n{\n  constructor($container) {\n\n    this.$container = $container;\n    this.checkContent = {};\n    this.$form = $container.find('form');\n    this.$dialog = $container.find('#testpaper-checked-dialog');\n    this.validator = null;\n    this._initEvent();\n    this._init();\n    this._initValidate();\n  }\n\n  _initEvent() {\n    this.$container.on('focusin','textarea',event=>this._showEssayInputEditor(event));\n    this.$container.on('click','[data-role=\"check-submit\"]',event=>this._submitValidate(event));\n    this.$container.on('click','*[data-anchor]',event=>this._quick2Question(event));\n    this.$dialog.on('click','[data-role=\"finish-check\"]',event=>this._submit(event));\n    this.$dialog.on('change','select',event=>this._teacherSayFill(event));\n  }\n\n  _init() {\n\n  }\n\n  _showEssayInputEditor(event) {\n    let $shortTextarea = $(event.currentTarget);\n\n    if ($shortTextarea.hasClass('essay-teacher-say-short')) {\n      \n      event.preventDefault();\n      event.stopPropagation();\n      $(this).blur();\n      let $longTextarea = $shortTextarea.siblings('.essay-teacher-say-long');\n      let $textareaBtn = $longTextarea.siblings('.essay-teacher-say-btn');\n\n      $shortTextarea.hide();\n      $longTextarea.show();\n      $textareaBtn.show();\n\n      let editor = CKEDITOR.replace($longTextarea.attr('id'), {\n        toolbar: 'Minimal',\n        filebrowserImageUploadUrl: $longTextarea.data('imageUploadUrl')\n      });\n\n      editor.on('blur', function(e) {\n        editor.updateElement();\n        setTimeout(function() {\n          $longTextarea.val(editor.getData());\n          $longTextarea.change();\n        }, 1);\n      });\n\n      editor.on('instanceReady', function(e) {\n        this.focus();\n\n        $textareaBtn.one('click', function() {\n          $shortTextarea.val($(editor.getData()).text());\n          editor.destroy();\n          $longTextarea.hide();\n          $textareaBtn.hide();\n          $shortTextarea.show();\n        });\n      });\n\n      editor.on('key', function(){\n        editor.updateElement();\n        setTimeout(function() {\n          $longTextarea.val(editor.getData());\n          $longTextarea.change();\n        }, 1);\n      });\n\n      editor.on('insertHtml', function(e) {\n        editor.updateElement();\n        setTimeout(function() {\n          $longTextarea.val(editor.getData());\n          $longTextarea.change();\n        }, 1);\n      });\n    }\n    \n  }\n\n  _initValidate(event) {\n    this.validator = this.$form.validate();\n\n    if ($('*[data-score]:visible').length > 0) {\n      $('*[data-score]:visible').each(function(index){\n        $(this).rules('add',{\n          required:true,\n          score:true,\n          min:0,\n          messages: {    \n            required: \"请输入分数\",    \n          } \n        })\n      })\n    }\n\n  }\n\n  _quick2Question(event) {\n    let $target = $(event.currentTarget); \n    let position = $($target.data('anchor')).offset();\n    $(document).scrollTop(position.top - 55);\n  }\n\n  _submitValidate(event) {\n    let $target = $(event.currentTarget);\n    let scoreTotal = 0;\n\n    if (this.validator == undefined || this.validator.form()) {\n      let self = this;\n      $('*[data-score]').each(function(){\n        let content = {};\n        let questionId = $(this).data('id');\n        \n        content['score'] = Number($(this).val());\n        content['teacherSay'] = $('[name=\"teacherSay_'+questionId+'\"]').val();\n\n        self.checkContent[questionId] = content;\n        scoreTotal = scoreTotal + Number($(this).val());\n      })\n\n      let subjectiveScore = Number(this.$dialog.find('[name=\"objectiveScore\"]').val());\n      let totalScore = Number(scoreTotal) + subjectiveScore;\n\n      this.$dialog.find('#totalScore').html(totalScore);\n      this.$dialog.modal('show');\n    }\n\n\n  }\n\n  _submit(event) {\n\n    let $target = $(event.currentTarget);\n    let teacherSay = this.$dialog.find('textarea').val();\n    let passedStatus = this.$dialog.find('[name=\"passedStatus\"]:checked').val();\n\n    $target.button('loading');\n    $.post($target.data('postUrl'), {result:this.checkContent,teacherSay:teacherSay,passedStatus:passedStatus}, function(response) {\n      window.location.href = $target.data('goto');\n    })\n  }\n\n  _teacherSayFill(event) {\n    let $target = $(event.currentTarget);\n    let $option = $target.find('option:selected');\n\n    if ($option.val() == '') {\n      this.$dialog.find('textarea').val('');\n    } else {\n      this.$dialog.find('textarea').val($option.text());\n    }\n  }\n}\n\nnew CheckTest($('.container'));\n"]}