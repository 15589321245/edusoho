#!/bin/bash
# global var

phpunitArray=()
sourceArray=()
phpunitStr=''
sourceStr=''
index=1
currentPath=`pwd`

function inArray() {
	value=$1
	arr=$2
	flag=0 #not in

	for i in ${arr[@]}
	do
		[ "$i" == "$value" ] && flag=1 #in
	done

}

# classname
function filterClassName() {
	className=$1
	if [[ $className = *\.php* && $className != *vendor\/*\.php* && $className != *api\/*\.php* ]]; then
		if [[  $className = *src\/Biz\/*Impl\.php*  ]]; then
			sourceClassName=$className
			flag=0
			for value in ${sourceArray[@]}
			do
				[ "$sourceClassName" == "$value" ] && flag=1
			done
			if [[  $flag = 0  ]]; then
				sourceArray[$index]=$sourceClassName
			fi
			testClassName=${className//src\/Biz//tests\/Unit}
			testClassName=${testClassName//\/Impl/}
			testClassName=${testClassName//Impl\.php/Test\.php}
			flag=0
			for value in ${phpunitArray[@]}
			do
				[ "$testClassName" == "$value" ] && flag=1 #in
			done
			if [[  $flag = 0  ]]; then
				phpunitArray[$index]=$testClassName
			fi
		elif [[  $className = *Test\.php* ]]; then
			phpunitArray[$index]=$className
		fi
	fi
}

echo '创建app/data目录'
mkdir -p app/data
echo '开始比对差异文件'
git diff master --name-only --diff-filter=ACMRTUXB >> app/data/phpunit-dif-files
echo '显示差异文件'
cat app/data/phpunit-dif-files
echo '开始跑单元测试'
while read line
do
	filterClassName $line
	((index++))
done < app/data/phpunit-dif-files

for class in ${phpunitArray[@]}
do
	fileName=${currentPath}/${class}
	if [  -f "$fileName" ]; then
		echo "------------------------------------"
		echo "测试文件 $fileName"
		bin/phpunit -c app/ $fileName
	else
		echo "测试文件#$fileName不存在"
	fi
done
rm app/data/phpunit-dif-files
echo '结束'
