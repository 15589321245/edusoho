{"version":3,"sources":["node_modules/.2.0.5@postal/lib/postal.js"],"names":["root","factory","define","amd","_","module","exports","require","postal","global","undefined","prevPostal","prevLodash","noConflict","_defaultConfig","DEFAULT_CHANNEL","SYSTEM_CHANNEL","enableSystemMessages","cacheKeyDelimiter","autoCompactResolver","configuration","extend","_config","ChannelDefinition","channelName","bus","channel","prototype","subscribe","topic","arguments","length","callback","publish","envelope","data","Error","headers","resolverNoCache","SubscriptionDefinition","pipeline","cacheKeys","_context","ConsecutiveDistinctPredicate","previous","eq","isEqual","DistinctPredicate","DistinctPredicateFactory","isDistinct","some","p","push","errorHandler","original","safeCallback","apply","err","defer","delay","disposeAfter","maxCalls","dispose","after","unsubscribe","bind","env","next","distinct","constraint","distinctUntilChanged","invokeSubscriber","inactive","self","len","context","idx","invoked","call","concat","step","d","e","logError","console","report","warn","log","catch","once","predicate","constraints","predicates","each","contextSetter","debounce","milliseconds","immediate","options","leading","trailing","setTimeout","throttle","fn","bindingsResolver","resolver","cache","regex","enableCache","compare","binding","headerOptions","pattern","rgx","prevSegment","cacheKey","result","opt","saveToCache","indexOf","map","split","mapTopicBinding","segment","res","join","RegExp","test","reset","purge","keyDelimiter","matchPredicate","val","key","compactPredicate","getSubscribersFor","handler","compact","pubInProgress","unSubQueue","autoCompactIndex","clearUnSubQueue","shift","getCachePurger","subDef","sub","i","list","splice","getCacher","pubCache","done","getSystemMessage","kind","event","sysCreatedMessage","sysRemovedMessage","getPredicate","compared","matched","prop","subscriptions","wireTaps","addWireTap","window","subList","filter","cb","timeStamp","Date","tap","skipped","activated","cacherFn","candidate","candidates","unsubscribeFor","channelLen","subs","keys","substr","unSubLen","unSubIdx","channelSubs","topicSubs","pop","autoCompact","toDispose","Object","hasOwnProperty","isArray","__postalReady__","onReady"],"mappings":"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","file":"postal.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["/**\n * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.\n * Author: Jim Cowart (http://ifandelse.com)\n * Version: v2.0.5\n * Url: http://github.com/postaljs/postal.js\n * License(s): MIT\n */\n\n( function( root, factory ) {\n\t\n\tif ( typeof define === \"function\" && define.amd ) {\n\t\t// AMD. Register as an anonymous module.\n\t\tdefine( [ \"lodash\" ], function( _ ) {\n\t\t\treturn factory( _, root );\n\t\t} );\n\t\n\t} else if ( typeof module === \"object\" && module.exports ) {\n\t\t// Node, or CommonJS-Like environments\n\t\tmodule.exports = factory( require( \"lodash\" ), this );\n\t} else {\n\t\t// Browser globals\n\t\troot.postal = factory( root._, root );\n\t}\n}( this, function( _, global, undefined ) {\n\tvar prevPostal = global && global.postal;\n\tvar prevLodash = global && global._;\n\tif ( prevLodash && prevLodash !== _ ) {\n\t\t_ = _.noConflict();\n\t}\n\tvar _defaultConfig = {\n\t\tDEFAULT_CHANNEL: \"/\",\n\t\tSYSTEM_CHANNEL: \"postal\",\n\t\tenableSystemMessages: true,\n\t\tcacheKeyDelimiter: \"|\",\n\t\tautoCompactResolver: false\n\t};\n\tvar postal = {\n\t\tconfiguration: _.extend( {}, _defaultConfig )\n\t};\n\tvar _config = postal.configuration;\n\n\t\n\nvar ChannelDefinition = function( channelName, bus ) {\n\tthis.bus = bus;\n\tthis.channel = channelName || _config.DEFAULT_CHANNEL;\n};\n\nChannelDefinition.prototype.subscribe = function() {\n\treturn this.bus.subscribe( {\n\t\tchannel: this.channel,\n\t\ttopic: ( arguments.length === 1 ? arguments[ 0 ].topic : arguments[ 0 ] ),\n\t\tcallback: ( arguments.length === 1 ? arguments[ 0 ].callback : arguments[ 1 ] )\n\t} );\n};\n\n/*\n    publish( envelope [, callback ] );\n    publish( topic, data [, callback ] );\n*/\nChannelDefinition.prototype.publish = function() {\n\tvar envelope = {};\n\tvar callback;\n\tif ( typeof arguments[ 0 ] === \"string\" ) {\n\t\tenvelope.topic = arguments[ 0 ];\n\t\tenvelope.data = arguments[ 1 ];\n\t\tcallback = arguments[ 2 ];\n\t} else {\n\t\tenvelope = arguments[ 0 ];\n\t\tcallback = arguments[ 1 ];\n\t}\n\tif ( typeof envelope !== \"object\" ) {\n\t\tthrow new Error( \"The first argument to ChannelDefinition.publish should be either an envelope object or a string topic.\" );\n\t}\n\tenvelope.headers = _.extend( envelope.headers || { resolverNoCache: _config.resolverNoCache } );\n\tenvelope.channel = this.channel;\n\tthis.bus.publish( envelope, callback );\n};\n\n\t\nvar SubscriptionDefinition = function( channel, topic, callback ) {\n\tif ( arguments.length !== 3 ) {\n\t\tthrow new Error( \"You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.\" );\n\t}\n\tif ( topic.length === 0 ) {\n\t\tthrow new Error( \"Topics cannot be empty\" );\n\t}\n\tthis.channel = channel;\n\tthis.topic = topic;\n\tthis.callback = callback;\n\tthis.pipeline = [];\n\tthis.cacheKeys = [];\n\tthis._context = undefined;\n};\n\nvar ConsecutiveDistinctPredicate = function() {\n\tvar previous;\n\treturn function( data ) {\n\t\tvar eq = false;\n\t\tif ( typeof data === \"string\" ) {\n\t\t\teq = data === previous;\n\t\t\tprevious = data;\n\t\t} else {\n\t\t\teq = _.isEqual( data, previous );\n\t\t\tprevious = _.extend( {}, data );\n\t\t}\n\t\treturn !eq;\n\t};\n};\n\nvar DistinctPredicate = function DistinctPredicateFactory() {\n\tvar previous = [];\n\treturn function DistinctPredicate( data ) {\n\t\tvar isDistinct = !_.some( previous, function( p ) {\n\t\t\treturn _.isEqual( data, p );\n\t\t} );\n\t\tif ( isDistinct ) {\n\t\t\tprevious.push( data );\n\t\t}\n\t\treturn isDistinct;\n\t};\n};\n\nSubscriptionDefinition.prototype = {\n\n\t\"catch\": function( errorHandler ) {\n\t\tvar original = this.callback;\n\t\tvar safeCallback = function() {\n\t\t\ttry {\n\t\t\t\toriginal.apply( this, arguments );\n\t\t\t} catch ( err ) {\n\t\t\t\terrorHandler( err, arguments[ 0 ] );\n\t\t\t}\n\t\t};\n\t\tthis.callback = safeCallback;\n\t\treturn this;\n\t},\n\n\tdefer: function defer() {\n\t\treturn this.delay( 0 );\n\t},\n\n\tdisposeAfter: function disposeAfter( maxCalls ) {\n\t\tif ( typeof maxCalls !== \"number\" || maxCalls <= 0 ) {\n\t\t\tthrow new Error( \"The value provided to disposeAfter (maxCalls) must be a number greater than zero.\" );\n\t\t}\n\t\tvar dispose = _.after( maxCalls, this.unsubscribe.bind( this ) );\n\t\tthis.pipeline.push( function( data, env, next ) {\n\t\t\tnext( data, env );\n\t\t\tdispose();\n\t\t} );\n\t\treturn this;\n\t},\n\n\tdistinct: function distinct() {\n\t\treturn this.constraint( new DistinctPredicate() );\n\t},\n\n\tdistinctUntilChanged: function distinctUntilChanged() {\n\t\treturn this.constraint( new ConsecutiveDistinctPredicate() );\n\t},\n\n\tinvokeSubscriber: function invokeSubscriber( data, env ) {\n\t\tif ( !this.inactive ) {\n\t\t\tvar self = this;\n\t\t\tvar pipeline = self.pipeline;\n\t\t\tvar len = pipeline.length;\n\t\t\tvar context = self._context;\n\t\t\tvar idx = -1;\n\t\t\tvar invoked = false;\n\t\t\tif ( !len ) {\n\t\t\t\tself.callback.call( context, data, env );\n\t\t\t\tinvoked = true;\n\t\t\t} else {\n\t\t\t\tpipeline = pipeline.concat( [ self.callback ] );\n\t\t\t\tvar step = function step( d, e ) {\n\t\t\t\t\tidx += 1;\n\t\t\t\t\tif ( idx < len ) {\n\t\t\t\t\t\tpipeline[ idx ].call( context, d, e, step );\n\t\t\t\t\t} else {\n\t\t\t\t\t\tself.callback.call( context, d, e );\n\t\t\t\t\t\tinvoked = true;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tstep( data, env, 0 );\n\t\t\t}\n\t\t\treturn invoked;\n\t\t}\n\t},\n\n\tlogError: function logError() {\n\t\t\n\t\tif ( console ) {\n\t\t\tvar report;\n\t\t\tif ( console.warn ) {\n\t\t\t\treport = console.warn;\n\t\t\t} else {\n\t\t\t\treport = console.log;\n\t\t\t}\n\t\t\tthis.catch( report );\n\t\t}\n\t\treturn this;\n\t},\n\n\tonce: function once() {\n\t\treturn this.disposeAfter( 1 );\n\t},\n\n\tsubscribe: function subscribe( callback ) {\n\t\tthis.callback = callback;\n\t\treturn this;\n\t},\n\n\tunsubscribe: function unsubscribe() {\n\t\t\n\t\tif ( !this.inactive ) {\n\t\t\tpostal.unsubscribe( this );\n\t\t}\n\t},\n\n\tconstraint: function constraint( predicate ) {\n\t\tif ( typeof predicate !== \"function\" ) {\n\t\t\tthrow new Error( \"Predicate constraint must be a function\" );\n\t\t}\n\t\tthis.pipeline.push( function( data, env, next ) {\n\t\t\tif ( predicate.call( this, data, env ) ) {\n\t\t\t\tnext( data, env );\n\t\t\t}\n\t\t} );\n\t\treturn this;\n\t},\n\n\tconstraints: function constraints( predicates ) {\n\t\tvar self = this;\n\t\t\n\t\t_.each( predicates, function( predicate ) {\n\t\t\tself.constraint( predicate );\n\t\t} );\n\t\treturn self;\n\t},\n\n\tcontext: function contextSetter( context ) {\n\t\tthis._context = context;\n\t\treturn this;\n\t},\n\n\tdebounce: function debounce( milliseconds, immediate ) {\n\t\tif ( typeof milliseconds !== \"number\" ) {\n\t\t\tthrow new Error( \"Milliseconds must be a number\" );\n\t\t}\n\n\t\tvar options = {};\n\n\t\tif ( !!immediate === true ) { \n\t\t\toptions.leading = true;\n\t\t\toptions.trailing = false;\n\t\t}\n\n\t\tthis.pipeline.push(\n\t\t\t_.debounce( function( data, env, next ) {\n\t\t\t\tnext( data, env );\n\t\t\t},\n\t\t\t\tmilliseconds,\n\t\t\t\toptions\n\t\t\t)\n\t\t);\n\t\treturn this;\n\t},\n\n\tdelay: function delay( milliseconds ) {\n\t\tif ( typeof milliseconds !== \"number\" ) {\n\t\t\tthrow new Error( \"Milliseconds must be a number\" );\n\t\t}\n\t\tvar self = this;\n\t\tself.pipeline.push( function( data, env, next ) {\n\t\t\tsetTimeout( function() {\n\t\t\t\tnext( data, env );\n\t\t\t}, milliseconds );\n\t\t} );\n\t\treturn this;\n\t},\n\n\tthrottle: function throttle( milliseconds ) {\n\t\tif ( typeof milliseconds !== \"number\" ) {\n\t\t\tthrow new Error( \"Milliseconds must be a number\" );\n\t\t}\n\t\tvar fn = function( data, env, next ) {\n\t\t\tnext( data, env );\n\t\t};\n\t\tthis.pipeline.push( _.throttle( fn, milliseconds ) );\n\t\treturn this;\n\t}\n};\n\n\t\n\n\nvar bindingsResolver = _config.resolver = {\n\tcache: {},\n\tregex: {},\n\tenableCache: true,\n\n\tcompare: function compare( binding, topic, headerOptions ) {\n\t\tvar pattern;\n\t\tvar rgx;\n\t\tvar prevSegment;\n\t\tvar cacheKey = topic + _config.cacheKeyDelimiter + binding;\n\t\tvar result = ( this.cache[ cacheKey ] );\n\t\tvar opt = headerOptions || {};\n\t\tvar saveToCache = this.enableCache && !opt.resolverNoCache;\n\t\t// result is cached?\n\t\tif ( result === true ) {\n\t\t\treturn result;\n\t\t}\n\t\t// plain string matching?\n\t\tif ( binding.indexOf( \"#\" ) === -1 && binding.indexOf( \"*\" ) === -1 ) {\n\t\t\tresult = ( topic === binding );\n\t\t\tif ( saveToCache ) {\n\t\t\t\tthis.cache[ cacheKey ] = result;\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t\t// ah, regex matching, then\n\t\tif ( !( rgx = this.regex[ binding ] ) ) {\n\t\t\tpattern = \"^\" + _.map( binding.split( \".\" ), function mapTopicBinding( segment ) {\n\t\t\t\t\tvar res = \"\";\n\t\t\t\t\tif ( !!prevSegment ) {\n\t\t\t\t\t\tres = prevSegment !== \"#\" ? \"\\\\.\\\\b\" : \"\\\\b\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( segment === \"#\" ) {\n\t\t\t\t\t\tres += \"[\\\\s\\\\S]*\";\n\t\t\t\t\t} else if ( segment === \"*\" ) {\n\t\t\t\t\t\tres += \"[^.]+\";\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres += segment;\n\t\t\t\t\t}\n\t\t\t\t\tprevSegment = segment;\n\t\t\t\t\treturn res;\n\t\t\t\t} ).join( \"\" ) + \"$\";\n\t\t\trgx = this.regex[ binding ] = new RegExp( pattern );\n\t\t}\n\t\tresult = rgx.test( topic );\n\t\tif ( saveToCache ) {\n\t\t\tthis.cache[ cacheKey ] = result;\n\t\t}\n\t\treturn result;\n\t},\n\n\treset: function reset() {\n\t\tthis.cache = {};\n\t\tthis.regex = {};\n\t},\n\n\tpurge: function( options ) {\n\t\tvar self = this;\n\t\tvar keyDelimiter = _config.cacheKeyDelimiter;\n\t\tvar matchPredicate = function( val, key ) {\n\t\t\tvar split = key.split( keyDelimiter );\n\t\t\tvar topic = split[ 0 ];\n\t\t\tvar binding = split[ 1 ];\n\t\t\tif ( ( typeof options.topic === \"undefined\" || options.topic === topic ) &&\n\t\t\t\t\t( typeof options.binding === \"undefined\" || options.binding === binding ) ) {\n\t\t\t\tdelete self.cache[ key ];\n\t\t\t}\n\t\t};\n\n\t\tvar compactPredicate = function( val, key ) {\n\t\t\tvar split = key.split( keyDelimiter );\n\t\t\tif ( postal.getSubscribersFor( { topic: split[ 0 ] } ).length === 0 ) {\n\t\t\t\tdelete self.cache[ key ];\n\t\t\t}\n\t\t};\n\n\t\tif ( typeof options === \"undefined\" ) {\n\t\t\tthis.reset();\n\t\t} else {\n\t\t\tvar handler = options.compact === true ? compactPredicate : matchPredicate;\n\t\t\t_.each( this.cache, handler );\n\t\t}\n\t}\n};\n\n\t\n\n\nvar pubInProgress = 0;\nvar unSubQueue = [];\nvar autoCompactIndex = 0;\n\nfunction clearUnSubQueue() {\n\twhile ( unSubQueue.length ) {\n\t\tpostal.unsubscribe( unSubQueue.shift() );\n\t}\n}\n\nfunction getCachePurger( subDef, key, cache ) {\n\treturn function( sub, i, list ) {\n\t\tif ( sub === subDef ) {\n\t\t\tlist.splice( i, 1 );\n\t\t}\n\t\tif ( list.length === 0 ) {\n\t\t\tdelete cache[ key ];\n\t\t}\n\t};\n}\n\nfunction getCacher( topic, pubCache, cacheKey, done, envelope ) {\n\tvar headers = envelope && envelope.headers || {};\n\treturn function( subDef ) {\n\t\tvar cache;\n\t\tif ( _config.resolver.compare( subDef.topic, topic, headers ) ) {\n\t\t\tif ( !headers.resolverNoCache ) {\n\t\t\t\tcache = pubCache[ cacheKey ] = ( pubCache[ cacheKey ] || [] );\n\t\t\t\tcache.push( subDef );\n\t\t\t\tsubDef.cacheKeys.push( cacheKey );\n\t\t\t}\n\t\t\tif ( done ) {\n\t\t\t\tdone( subDef );\n\t\t\t}\n\t\t}\n\t};\n}\n\nfunction getSystemMessage( kind, subDef ) {\n\treturn {\n\t\tchannel: _config.SYSTEM_CHANNEL,\n\t\ttopic: \"subscription.\" + kind,\n\t\tdata: {\n\t\t\tevent: \"subscription.\" + kind,\n\t\t\tchannel: subDef.channel,\n\t\t\ttopic: subDef.topic\n\t\t}\n\t};\n}\n\nvar sysCreatedMessage = getSystemMessage.bind( undefined, \"created\" );\nvar sysRemovedMessage = getSystemMessage.bind( undefined, \"removed\" );\n\nfunction getPredicate( options, resolver ) {\n\tif ( typeof options === \"function\" ) {\n\t\treturn options;\n\t} else if ( !options ) {\n\t\treturn function() {\n\t\t\treturn true;\n\t\t};\n\t} else {\n\t\treturn function( sub ) {\n\t\t\tvar compared = 0;\n\t\t\tvar matched = 0;\n\t\t\t_.each( options, function( val, prop ) {\n\t\t\t\tcompared += 1;\n\t\t\t\tif (\n\t\t\t\t// We use the bindings resolver to compare the options.topic to subDef.topic\n\t\t\t\t( prop === \"topic\" && resolver.compare( sub.topic, options.topic, { resolverNoCache: true } ) ) ||\n\t\t\t\t\t\t( prop === \"context\" && options.context === sub._context ) ||\n\t\t\t\t\t\t// Any other potential prop/value matching outside topic & context...\n\t\t\t\t\t\t( sub[ prop ] === options[ prop ] ) ) {\n\t\t\t\t\tmatched += 1;\n\t\t\t\t}\n\t\t\t} );\n\t\t\treturn compared === matched;\n\t\t};\n\t}\n}\n\n_.extend( postal, {\n\tcache: {},\n\tsubscriptions: {},\n\twireTaps: [],\n\n\tChannelDefinition: ChannelDefinition,\n\tSubscriptionDefinition: SubscriptionDefinition,\n\n\tchannel: function channel( channelName ) {\n\t\treturn new ChannelDefinition( channelName, this );\n\t},\n\n\taddWireTap: function addWireTap( callback ) {\n\t\tvar self = this;\n\t\tself.wireTaps.push( callback );\n\t\treturn function() {\n\t\t\tvar idx = self.wireTaps.indexOf( callback );\n\t\t\tif ( idx !== -1 ) {\n\t\t\t\tself.wireTaps.splice( idx, 1 );\n\t\t\t}\n\t\t};\n\t},\n\n\tnoConflict: function noConflict() {\n\t\t\n\t\tif ( typeof window === \"undefined\" || ( typeof window !== \"undefined\" && typeof define === \"function\" && define.amd ) ) {\n\t\t\tthrow new Error( \"noConflict can only be used in browser clients which aren't using AMD modules\" );\n\t\t}\n\t\tglobal.postal = prevPostal;\n\t\treturn this;\n\t},\n\n\tgetSubscribersFor: function getSubscribersFor( options ) {\n\t\tvar result = [];\n\t\tvar self = this;\n\t\t_.each( self.subscriptions, function( channel ) {\n\t\t\t_.each( channel, function( subList ) {\n\t\t\t\tresult = result.concat( _.filter( subList, getPredicate( options, _config.resolver ) ) );\n\t\t\t} );\n\t\t} );\n\t\treturn result;\n\t},\n\n\tpublish: function publish( envelope, cb ) {\n\t\t++pubInProgress;\n\t\tvar channel = envelope.channel = envelope.channel || _config.DEFAULT_CHANNEL;\n\t\tvar topic = envelope.topic;\n\t\tenvelope.timeStamp = new Date();\n\t\tif ( this.wireTaps.length ) {\n\t\t\t_.each( this.wireTaps, function( tap ) {\n\t\t\t\ttap( envelope.data, envelope, pubInProgress );\n\t\t\t} );\n\t\t}\n\t\tvar cacheKey = channel + _config.cacheKeyDelimiter + topic;\n\t\tvar cache = this.cache[ cacheKey ];\n\t\tvar skipped = 0;\n\t\tvar activated = 0;\n\t\tif ( !cache ) {\n\t\t\tvar cacherFn = getCacher(\n\t\t\t\ttopic,\n\t\t\t\tthis.cache,\n\t\t\t\tcacheKey,\n\t\t\t\tfunction( candidate ) {\n\t\t\t\t\tif ( candidate.invokeSubscriber( envelope.data, envelope ) ) {\n\t\t\t\t\t\tactivated++;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tskipped++;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tenvelope\n\t\t\t);\n\t\t\t_.each( this.subscriptions[ channel ], function( candidates ) {\n\t\t\t\t_.each( candidates, cacherFn );\n\t\t\t} );\n\t\t} else {\n\t\t\t_.each( cache, function( subDef ) {\n\t\t\t\tif ( subDef.invokeSubscriber( envelope.data, envelope ) ) {\n\t\t\t\t\tactivated++;\n\t\t\t\t} else {\n\t\t\t\t\tskipped++;\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t\tif ( --pubInProgress === 0 ) {\n\t\t\tclearUnSubQueue();\n\t\t}\n\t\tif ( cb ) {\n\t\t\tcb( {\n\t\t\t\tactivated: activated,\n\t\t\t\tskipped: skipped\n\t\t\t} );\n\t\t}\n\t},\n\n\treset: function reset() {\n\t\tthis.unsubscribeFor();\n\t\t_config.resolver.reset();\n\t\tthis.subscriptions = {};\n\t\tthis.cache = {};\n\t},\n\n\tsubscribe: function subscribe( options ) {\n\t\tvar subscriptions = this.subscriptions;\n\t\tvar subDef = new SubscriptionDefinition( options.channel || _config.DEFAULT_CHANNEL, options.topic, options.callback );\n\t\tvar channel = subscriptions[ subDef.channel ];\n\t\tvar channelLen = subDef.channel.length;\n\t\tvar subs;\n\t\tif ( !channel ) {\n\t\t\tchannel = subscriptions[ subDef.channel ] = {};\n\t\t}\n\t\tsubs = subscriptions[ subDef.channel ][ subDef.topic ];\n\t\tif ( !subs ) {\n\t\t\tsubs = subscriptions[ subDef.channel ][ subDef.topic ] = [];\n\t\t}\n\t\t// First, add the SubscriptionDefinition to the channel list\n\t\tsubs.push( subDef );\n\t\t// Next, add the SubscriptionDefinition to any relevant existing cache(s)\n\t\tvar cache = this.cache;\n\t\t_.each( _.keys( cache ), function( cacheKey ) {\n\t\t\tif ( cacheKey.substr( 0, channelLen ) === subDef.channel ) {\n\t\t\t\tgetCacher(\n\t\t\t\t\tcacheKey.split( _config.cacheKeyDelimiter )[1],\n\t\t\t\t\tcache,\n\t\t\t\t\tcacheKey )( subDef );\n\t\t\t}\n\t\t} );\n\t\t\n\t\tif ( _config.enableSystemMessages ) {\n\t\t\tthis.publish( sysCreatedMessage( subDef ) );\n\t\t}\n\t\treturn subDef;\n\t},\n\n\tunsubscribe: function unsubscribe() {\n\t\tvar unSubLen = arguments.length;\n\t\tvar unSubIdx = 0;\n\t\tvar subDef;\n\t\tvar channelSubs;\n\t\tvar topicSubs;\n\t\tvar idx;\n\t\tfor ( ; unSubIdx < unSubLen; unSubIdx++ ) {\n\t\t\tsubDef = arguments[ unSubIdx ];\n\t\t\tsubDef.inactive = true;\n\t\t\tif ( pubInProgress ) {\n\t\t\t\tunSubQueue.push( subDef );\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tchannelSubs = this.subscriptions[ subDef.channel ];\n\t\t\ttopicSubs = channelSubs && channelSubs[ subDef.topic ];\n\t\t\t\n\t\t\tif ( topicSubs ) {\n\t\t\t\tvar len = topicSubs.length;\n\t\t\t\tidx = 0;\n\t\t\t\t// remove SubscriptionDefinition from channel list\n\t\t\t\twhile ( idx < len ) {\n\t\t\t\t\t\n\t\t\t\t\tif ( topicSubs[ idx ] === subDef ) {\n\t\t\t\t\t\ttopicSubs.splice( idx, 1 );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tidx += 1;\n\t\t\t\t}\n\t\t\t\tif ( topicSubs.length === 0 ) {\n\t\t\t\t\tdelete channelSubs[ subDef.topic ];\n\t\t\t\t\tif ( !_.keys( channelSubs ).length ) {\n\t\t\t\t\t\tdelete this.subscriptions[ subDef.channel ];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// remove SubscriptionDefinition from postal cache\n\t\t\t\tif ( subDef.cacheKeys && subDef.cacheKeys.length ) {\n\t\t\t\t\tvar key;\n\t\t\t\t\twhile ( key = subDef.cacheKeys.pop() ) {\n\t\t\t\t\t\t_.each( this.cache[ key ], getCachePurger( subDef, key, this.cache ) );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( typeof _config.resolver.purge === \"function\" ) {\n\t\t\t\t\t// check to see if relevant resolver cache entries can be purged\n\t\t\t\t\tvar autoCompact = _config.autoCompactResolver === true ?\n\t\t\t\t\t\t0 : typeof _config.autoCompactResolver === \"number\" ?\n\t\t\t\t\t\t\t( _config.autoCompactResolver - 1 ) : false;\n\t\t\t\t\tif ( autoCompact >= 0 && autoCompactIndex === autoCompact ) {\n\t\t\t\t\t\t_config.resolver.purge( { compact: true } );\n\t\t\t\t\t\tautoCompactIndex = 0;\n\t\t\t\t\t} else if ( autoCompact >= 0 && autoCompactIndex < autoCompact ) {\n\t\t\t\t\t\tautoCompactIndex += 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( _config.enableSystemMessages ) {\n\t\t\t\tthis.publish( sysRemovedMessage( subDef ) );\n\t\t\t}\n\t\t}\n\t},\n\n\tunsubscribeFor: function unsubscribeFor( options ) {\n\t\tvar toDispose = [];\n\t\t\n\t\tif ( this.subscriptions ) {\n\t\t\ttoDispose = this.getSubscribersFor( options );\n\t\t\tthis.unsubscribe.apply( this, toDispose );\n\t\t}\n\t}\n} );\n\n\n\t\n\tif ( global && Object.prototype.hasOwnProperty.call( global, \"__postalReady__\" ) && _.isArray( global.__postalReady__ ) ) {\n\t\twhile ( global.__postalReady__.length ) {\n\t\t\tglobal.__postalReady__.shift().onReady( postal );\n\t\t}\n\t}\n\t\n\n\treturn postal;\n} ) );\n"]}