{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/download/download.js"],"names":["DownLoad","$form","$","validator2","firstName","val","initStep2Form","bindEvent","initFileChooser","validate","rules","title","required","maxlength","trim","link","materials","messages","data","on","itemDelete","event","videoImport","addFileBtn","titleChange","$parent","currentTarget","closest","mediaId","items","isEmpty","JSON","parse","stringify","siblings","length","remove","state","addFile","fileSelect","file","text","name","fileChooser","$this","obj","undefined","Object","keys","addToList","hide","valid","source","id","summary","size","media","Translator","trans","show","setTimeout","slideUp","item_tpl","append","tooltip","removeClass","form"],"mappings":"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","file":"download.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import FileChooser from '../../file-chooser/file-choose';\nimport notify from 'common/notify';\nimport { chooserUiOpen } from '../widget/chooser-ui.js';\n\nexport default class DownLoad {\n  constructor() {\n    this.$form = $('#step2-form');\n    this.validator2 = null;\n    this.firstName = $('#title').val();\n    this.initStep2Form();\n    this.bindEvent();\n    this.initFileChooser();\n  }\n  initStep2Form() {\n    let validator2 = this.$form.validate({\n      rules: {\n        title: {\n          required: true,\n          maxlength: 50,\n          trim: true,\n        },\n        link: 'url',\n        materials: 'required',\n      },\n      messages: {\n        link: \"链接地址不正确\",\n        materials: '请上传或选择%display%'\n      }\n    });\n    this.$form.data('validator', validator2);\n  }\n\n  bindEvent() {\n    this.$form.on('click', '.js-btn-delete', () => this.itemDelete(event));\n    this.$form.on('click', '.js-video-import', () => this.videoImport(false));\n    this.$form.on('click', '.js-add-file-list', () => this.addFileBtn(true));\n    this.$form.on('change', '#title', () => this.titleChange(event));\n  }\n\n  itemDelete(event) {\n    let $parent = $(event.currentTarget).closest('li');\n    let mediaId = $parent.data('id');\n    let items = this.isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n    if (items && items[mediaId]) {\n      delete items[mediaId];\n      $(\"#materials\").val(JSON.stringify(items));\n    }\n    if ($parent.siblings('li').length <= 0) {\n      $(\"#materials\").val(null);\n    }\n    $parent.remove();\n  }\n\n  videoImport(state) {\n    this.addFile(state);\n  }\n\n  addFileBtn(state) {\n    this.addFile(state);\n  }\n\n  initFileChooser() {\n    const fileSelect = file => {\n      $(\"input[name=media]\").val(JSON.stringify(file));\n      chooserUiOpen();\n      this.addFile(false);\n      if (this.firstName) {\n        $('#title').val(this.firstName);\n      } else {\n        $('#title').val('');\n      }\n      $('.js-current-file').text(file.name);\n    }\n\n    const fileChooser = new FileChooser();\n\n    fileChooser.on('select', fileSelect);\n  }\n\n  titleChange(event) {\n    let $this = $(event.currentTarget);\n    this.firstName = $this.val();\n  }\n\n  isEmpty(obj) {\n    return obj == null || obj == \"\" || obj == undefined || Object.keys(obj).length == 0;\n  }\n\n  addFile(addToList) {\n    //@TODO重构代码\n    $('.js-success-redmine').hide();\n    if (this.isEmpty($(\"#media\").val()) && $(\"#step2-form\").data('validator') && $(\"#step2-form\").data('validator').valid() && $(\"#link\").val().length > 0) {\n      if (!addToList) {\n        $(\"#verifyLink\").val($(\"#link\").val());\n      }\n      let data = {\n        source: 'link',\n        id: $(\"#verifyLink\").val(),\n        name: $(\"#verifyLink\").val(),\n        link: $(\"#verifyLink\").val(),\n        summary: $(\"#file-summary\").val(),\n        size: 0\n      };\n      $('.js-current-file').text($(\"#verifyLink\").val());\n      $(\"#media\").val(JSON.stringify(data));\n    }\n\n\n    let media = this.isEmpty($(\"#media\").val()) ? {} : JSON.parse($(\"#media\").val());\n    let items = this.isEmpty($(\"#materials\").val()) ? {} : JSON.parse($(\"#materials\").val());\n\n    if (!this.isEmpty(items) && items[media.id]) {\n      $('.js-danger-redmine').text(Translator.trans('该文件已添加，请重新选择')).show();\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      $('.js-current-file').text('');\n      $(\"#media\").val(null);\n      media = null;\n      return;\n    }\n\n    if (!addToList) {\n      return;\n    }\n\n    if (addToList && this.isEmpty(media)) {\n      $('.js-danger-redmine').text(Translator.trans('请上传或选择要添加的资料')).show();\n      $('.js-current-file').text('');\n      setTimeout(function () {\n        $('.js-danger-redmine').slideUp();\n      }, 3000);\n      return;\n    }\n\n\n    $('.js-current-file').text('');\n    media.summary = $(\"#file-summary\").val();\n    items[media.id] = media;\n    $(\"#materials\").val(JSON.stringify(items));\n\n    $(\"#media\").val(null);\n    $('#link').val(null);\n    $(\"#file-summary\").val(null);\n\n    if (!this.firstName) {\n      this.firstName = media.name;\n      $('#title').val(media.name);\n    }\n\n\n    let item_tpl = '';\n    if (media.link) {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.link}\">\n        <a class=\"gray-primary\" href=\"${ media.link}\" target=\"_blank\">${media.name}</a>\n        <a class=\"gray-primary phm btn-delete  js-btn-delete\"  href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"{{ '删除'|trans }}\"><i class=\"es-icon es-icon-delete\"></i></a>\n        <span class=\"glyphicon glyphicon-new-window text-muted text-sm\" title=\"${Translator.trans('删除')}\"></span>\n    </li>\n  `;\n    } else {\n      item_tpl = `\n    <li class=\"download-item \" data-id=\"${media.id}\">\n      <a class=\"gray-primary\" href=\"/materiallib/${ media.id}/download\">${media.name}</a>\n      <a class=\"gray-primary phm  btn-delete js-btn-delete\" href=\"javascript:;\"  data-url=\"\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"${Translator.trans('删除')}\"><i class=\"es-icon es-icon-delete\"></i></a>\n    </li>\n  `;\n    }\n    $(\"#material-list\").append(item_tpl);\n    $('[data-toggle=\"tooltip\"]').tooltip();\n    $('.file-browser-item').removeClass('active');\n    $('.js-danger-redmine').hide();\n    $('.js-success-redmine').text(Translator.trans('添加成功，可继续选择资料添加或点击下一步！')).show();\n    setTimeout(function () {\n      $('.js-success-redmine').slideUp();\n    }, 3000);\n    if ($('.jq-validate-error:visible').length > 0) {\n      $(\"#step2-form\").data('validator').form();\n    }\n  }\n}"]}