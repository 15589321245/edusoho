'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

// import postal from 'postal';
// import 'postal.federation/lib/postal.federation.min.js';
// import 'postal.xframe/lib/postal.xframe.min.js';

var TaskEventEmitter = function () {
  function TaskEventEmitter(element) {
    _classCallCheck(this, TaskEventEmitter);

    this.element = $(element);
    this.eventUrl = this.element.data('eventUrl');
    if (this.eventUrl === undefined) {
      throw Error('task event url is undefined');
    }

    this.eventMap = {
      receives: {}
    };

    this._registerIframeEvents();
  }

  _createClass(TaskEventEmitter, [{
    key: '_registerIframeEvents',
    value: function _registerIframeEvents() {
      // postal.instanceId('task');

      // postal.fedx.addFilter([
      //   {
      //     channel: 'activity-events', //接收 activity iframe的事件
      //     topic: '#',
      //     direction: 'in'
      //   },
      //   {
      //     channel: 'task-events',  // 发送事件到activity iframe
      //     topic: '#',
      //     direction: 'out'
      //   }
      // ]);

      this._registerReceiveActivityIframeEvents();
      return this;
    }
  }, {
    key: '_registerReceiveActivityIframeEvents',
    value: function _registerReceiveActivityIframeEvents() {
      // postal.subscribe({
      //   channel: 'activity-events',
      //   topic: '#',
      //   callback: ({event, data}) => {
      //     let listeners = this.eventMap.receives[event];
      //     $.post(this.eventUrl, {eventName: event, data: data})
      //         .done(response => {
      //           if (typeof listeners !== 'undefined') {
      //             listeners.forEach(callback => callback(response));
      //           }
      //           postal.publish({
      //             channel: 'task-events',
      //             topic: '#',
      //             data: response
      //           });
      //         })
      //         .fail((error) => {
      //           postal.publish({
      //             channel: 'task-events',
      //             topic: '#',
      //             data: { event: event, error: error }
      //           });
      //         });
      //   }
      // });

      return this;
    }

    //发送事件到activity

  }, {
    key: 'emit',
    value: function emit(event, data) {
      var _this = this;

      return new Promise(function (resolve, reject) {
        $.post(_this.eventUrl, { eventName: event, data: data }).done(function (response) {
          postal.publish({
            channel: 'task-events',
            topic: '#',
            data: { event: response.event, data: response.data }
          });
          resolve(response);
        }).fail(function (error) {
          reject(error);
        });
      });
    }

    // 监听activity的事件

  }, {
    key: 'receive',
    value: function receive(event, callback) {
      this.eventMap.receives[event] = this.eventMap.receives[event] || [];
      this.eventMap.receives[event].push(callback);
    }
  }]);

  return TaskEventEmitter;
}();

exports.default = TaskEventEmitter;