define(function(require, exports, module) {
    "use strict";

	var Validator = require('bootstrap.validator');
    
    Validator.addRule(
        'noNumberFirst',
        /^[a-zA-Z]+[a-zA-Z0-9]+?$/,
        'URL路径不能以数字开头'
    );

    var Notify = require('common/bootstrap-notify');
    var EditorFactory = require('common/kindeditor-factory');
    require('common/validator-rules').inject(Validator);
    require('jquery.select2-css');
    require('jquery.select2');
    require('jquery.bootstrap-datetimepicker');
    require('jquery.form');

	exports.run = function() {
		var $form = $("#article-form"),
            $modal = $form.parents('.modal');
        $form.data('uploading', false);

        var validator = _initValidator($form, $modal);
        var $editor = _initEditorFields($form, validator);
        _initTagsField();
        _initDatetimeFields($form);
        _changeEditor($editor);

	};

    function _changeEditor($editor)
    {
        $('input[name="editor"]:radio').change(
            function(){
               
               var editorType = $(this).val();
               var valueInHtml = $('#noneeditor-body-field').val();
               var valueInrichEditor = $editor.html();
               

               if(editorType == 'richeditor'){
                $editor.html(valueInHtml);
                $('#richeditor-body-field').parents('.form-group').show();
                $('#noneeditor-body-field').parents('.form-group').hide();

               } else if(editorType == 'none'){

                $('#noneeditor-body-field').val(valueInrichEditor);
                $('#noneeditor-body-field').parents('.form-group').show();
                $('#richeditor-body-field').parents('.form-group').hide();

               }
            }
        ); 
    }

    function _initValidator($form, $modal)
    {
        var validator = new Validator({
            element: $form,
            autoSubmit: false,
            onFormValidated: function(error, results, $form) {
                if (error) {
                    return ;
                }

                if ($form.data('uploading')) {
                    alert('正在上传附图，请等待附图上传成功后，再保存！');
                    return ;
                }

                $form.ajaxSubmit({
                    clearForm: true,
                    success: function(data){
                        $modal.modal('hide');
                        window.location.reload();
                    }
                });
            }
            
        });

        if ($form.find('[name="title"]').length > 0) {
            validator.addItem({
                element: '[name="title"]',
                required: true
            });
        }        

        if ($form.find('[name="alias"]').length > 0) {
            validator.addItem({
                element: '[name="alias"]',
                rule: 'remote noNumberFirst'
            });
        }
        return validator;
    }

    function _initEditorFields($form, validator)
    {
        
        var editor = EditorFactory.create('#richeditor-body-field', 'full', {extraFileUploadParams:{group:'default'}});
        validator.on('formValidate', function(elemetn, event) {
            editor.sync();
        });

        return editor;
    }

    function _initTagsField()
    {
        if ($('#article-tags-field').length < 1) {
            return ;
        }

//
        // $('#course_tags').select2({
        //     width: 'off',
        //     multiple: true,
        //     maximumSelectionSize: 20,
        //     id: 'name',
        //     data: {results:tags, key:'name'},
        //     formatSelection: function(item) {
        //         return item.name;
        //     },
        //     formatResult: function(item) {
        //         return item.name;
        //     },
        //     initSelection : function (element, callback) {
        //         var data = [];
        //         $(element.val().split(",")).each(function () {
        //             data.push({id: this, name: this});
        //         });
        //         callback(data);
        //     }
        // });
//
    $('#course_tags').select2({
            
            ajax: {
                url: app.arguments.tagMatchUrl+'#',
                dataType: 'json',
                quietMillis: 100,
                data: function (term, page) { 
                    return {
                        q: term, 
                        page_limit: 10
                    };
                },
                results: function (data) {

                    var results = [];

                    $.each(data, function(index, item){

                        results.push({
                          id: item.name,
                          name: item.name
                        });
                    });

                    return {
                        results: results
                    };

                }
            },
            initSelection : function (element, callback) {
                var data = [];
                $(element.val().split(",")).each(function () {
                    data.push({id: this, name: this});
                });
                callback(data);
            },
            formatSelection: function(item) {
                return item.name;
            },
            formatResult: function(item) {
                return item.name;
            },
            width: 'off',
            multiple: true,
            maximumSelectionSize: 20,
            placeholder: "请输入标签",
            width: 'off',
            multiple: true,
            createSearchChoice: function() { return null; },
            maximumSelectionSize: 20
        });
    }

    function _initDatetimeFields($form)
    {
        $form.find('[data-role=datetime-field]').each(function(){
            $(this).datetimepicker({
                format: 'yyyy-mm-dd hh:ii',
                pickerPosition: "top-right",
                autoclose: true,
                minuteStep: 10
            });
        });
    }

});