{"version":3,"sources":["app/Resources/static-src/app/js/activity/live/index.js"],"names":["LiveShow","init","that","activityData","JSON","parse","$","text","console","log","liveStartTimeFormat","startTimeFormat","liveEndTimeFormat","endTimeFormat","startTime","parseInt","endTime","nowDate","summary","courseId","fromCourseId","activityId","id","replayStatus","ext","$liveNotice","Translator","trans","liveStartTime","liveEndTime","iID","clearInterval","intervalSecond","entry_url","location","protocol","hostname","generateHtml","startLeftSeconds","endLeftSeconds","days","Math","floor","modulo","hours","minutes","seconds","$replayGuid","liveProvider","$countDown","_getCountDown","isTeacher","replays","length","each","i","n","url","title","$content","find","html","setInterval","show","scrollTop","started","emitter","emit","then","catch","error","window","open","content","liveShow"],"mappings":"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","file":"index.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import ActivityEmitter from \"../activity-emitter\";\n\nclass LiveShow {\n\n  constructor() {\n    this.init();\n  }\n\n  init() {\n    let that = this;\n    let activityData = JSON.parse($('#activity-data').text());\n    console.log('activityData : ', activityData);\n    let liveStartTimeFormat = activityData.startTimeFormat;\n    let liveEndTimeFormat = activityData.endTimeFormat;\n    let startTime = parseInt(activityData.startTime);\n    let endTime = parseInt(activityData.endTime);\n    let nowDate = parseInt(activityData.nowDate);\n    let summary = $('#activity-summary').text();\n\n    let courseId = activityData.fromCourseId;\n    let activityId = activityData.id;\n    let replayStatus = activityData.ext.replayStatus || 'ungenerated';\n\n    let $liveNotice = \"<p>\" + Translator.trans('直播将于%liveStartTime%开始，于%liveEndTime%结束，请在课前10分钟内提早进入。', {\n        liveStartTime: '<strong>' + liveStartTimeFormat + '</strong>',\n        liveEndTime: '<strong>' + liveEndTimeFormat + '</strong>'\n      }) + \"</p>\";\n\n    let iID;\n    if (iID) {\n      clearInterval(iID);\n    }\n\n    let intervalSecond = 0;\n    this.entry_url = location.protocol + \"//\" + location.hostname + '/course/' + courseId + '/activity/' + activityId + '/live_entry';\n\n    function generateHtml() {\n\n      nowDate = nowDate + intervalSecond;\n      let startLeftSeconds = parseInt(startTime - nowDate);\n      let endLeftSeconds = parseInt(endTime - nowDate);\n      let days = Math.floor(startLeftSeconds / (60 * 60 * 24));\n      let modulo = startLeftSeconds % (60 * 60 * 24);\n      let hours = Math.floor(modulo / (60 * 60));\n      modulo = modulo % (60 * 60);\n      let minutes = Math.floor(modulo / 60);\n      let seconds = modulo % 60;\n      let $replayGuid = Translator.trans('老师们：');\n\n      if (activityData.ext.liveProvider == 1) {\n        $replayGuid += Translator.trans('录制直播课程时，需在直播课程间点击');\n        $replayGuid += \"<span style='color:red'>\" + Translator.trans('录制面板') + \"</span>\";\n        $replayGuid += Translator.trans('，录制完成后点击');\n        $replayGuid += \"<span style='color:red'>\" + Translator.trans('暂停') + \"</span>\";\n        $replayGuid += Translator.trans('结束录播，录播结束后在');\n        $replayGuid += \"<span style='color:red'>\" + Translator.trans('录播管理') + \"</span>\";\n        $replayGuid += Translator.trans('界面生成回放。');\n      } else {\n        $replayGuid += Translator.trans('直播平台') + \"<span style='color:red'>\" + Translator.trans('下课后') + \"</span>\" + Translator.trans('且') + \"<span style='color:red'>\" + Translator.trans('直播时间') + \"</span>\" + Translator.trans('结束后，在课时管理的');\n        $replayGuid += \"<span style='color:red'>\" + Translator.trans('录播管理') + \"</span>\";\n        $replayGuid += Translator.trans('点击生成回放。');\n      }\n\n      $replayGuid = `<div class=\"mb20\">${$replayGuid }</div>`;\n\n      let $countDown = that._getCountDown(days, hours, minutes, seconds);\n\n      if (0 < startLeftSeconds && startLeftSeconds < 7200) {\n        $liveNotice = \"<p>\" + Translator.trans('直播将于%liveStartTime%开始，于%liveEndTime%结束，请在课前10分钟内提早进入。', {\n            liveStartTime: '<strong>' + liveStartTimeFormat + '</strong>',\n            liveEndTime: '<strong>' + liveEndTimeFormat + '</strong>'\n          }) + \"</p>\";\n        if (activityData.isTeacher) {\n          $countDown = $replayGuid + $countDown;\n          $countDown = \"<p>\" + $countDown + \"&nbsp;<a class='btn btn-primary js-start-live' href='javascript:;' onclick='liveShow.entryLiveRoom()'>\" + Translator.trans('进入直播教室') + \"</a><br><br></p>\";\n        } else {\n          $countDown = \"<p>\" + $countDown + \"&nbsp;<a class='btn btn-primary js-start-live' href='javascript:;' onclick='liveShow.entryLiveRoom()'>\" + Translator.trans('进入直播教室') + \"</a><br><br></p>\";\n        }\n      }\n      ;\n      if (startLeftSeconds <= 0) {\n        clearInterval(iID);\n        $liveNotice = \"<p>\" + Translator.trans('直播已经开始，直播将于%liveEndTime%结束。', {liveEndTime: '<strong class=\"color-warning\">' + liveEndTimeFormat + '</strong>'}) + \"</p>\";\n        if (!!activityData.isTeacher) {\n          $countDown = $replayGuid;\n          $countDown += \"<p><a class='btn btn-primary js-start-live' href='javascript:;' onclick='liveShow.entryLiveRoom()'>\" + Translator.trans('进入直播教室') + \"</a><br><br></p>\";\n        } else {\n          $countDown = \"<p><a class='btn btn-primary js-start-live' href='javascript:;' onclick='liveShow.entryLiveRoom()'>\" + Translator.trans('进入直播教室') + \"</a><br><br></p>\";\n        }\n      }\n      ;\n\n      if (endLeftSeconds <= 0) {\n\n        $liveNotice = \"<p style='margin: 10px 0 0 10px; font-weight: bold; font-size: 1.5em;'>\" + Translator.trans('直播已经结束') + \"</p>\";\n        $countDown = \"\";\n\n        if (activityData.replays && activityData.replays.length > 0) {\n          $.each(activityData.replays, function (i, n) {\n            $countDown += \"<a class='btn btn-primary' href='\" + n.url + \"' target='_blank'>\" + n.title + \"</a>&nbsp;&nbsp;\";\n          });\n        }\n      }\n\n      let $content = $liveNotice + '<p class=\"mt10\">' + summary + '</p>' + '<br>' + $countDown;\n      $(\"#lesson-live-content\").find('.lesson-content-text-body').html($content);\n\n      intervalSecond++;\n    }\n\n    generateHtml();\n    if (endTime > nowDate) {\n      iID = setInterval(generateHtml, 1000);\n    }\n\n    $(\"#lesson-live-content\").show();\n    $(\"#lesson-live-content\").scrollTop(0);\n\n    that.started = false;\n  }\n\n  entryLiveRoom() {\n    let that = this;\n    console.log('startLive', that.started, that.entry_url);\n    if (!that.started) {\n      that.started = true;\n      let emitter = new ActivityEmitter();\n      emitter.emit('start', {}).then(() => {\n        console.log('live.start');\n      }).catch((error) => {\n        console.error(error);\n      });\n    }\n    window.open(that.entry_url, '_blank');\n  }\n\n  _getCountDown(days, hours, minutes, seconds) {\n    let content = '';\n    content += days ?  days + Translator.trans(' 天 ') : \"\";\n    content += hours ?  hours + Translator.trans(' 小时 ') : \"\";\n    content += minutes ?  minutes + Translator.trans(' 分钟 ') : \"\";\n    content += seconds ?  seconds + Translator.trans(' 秒 ') : \"\";\n    content = `${Translator.trans('倒计时：')}<span class=\"color-warning\">${content}</span>`;\n    return content;\n  }\n}\n\nwindow.liveShow = new LiveShow();\n"]}