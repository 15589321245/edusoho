{"version":3,"sources":["app/Resources/static-src/app/js/activity-manage/video/subtitle/dialog.js"],"names":["SubtitleDialog","element","upload_id","inited","$","length","init","$container","closest","find","val","render","id","self","on","$elem","post","data","parent","remove","show","media","html","get","mediaId","initUploader","globalId","uploader","_destroyUploader","UploaderSDK","initUrl","finishUrl","ui","multi","accept","extensions","mimeTypes","type","process","videoNo","err","error","file","name","success","convertStatus","waiting","doing","none","append","hide","responseJSON","message","removeClass","addClass","__events","destroy","e"],"mappings":"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","file":"dialog.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import notify from 'common/notify';\n\nclass SubtitleDialog {\n\n  upload_id = 'subtitle-uploader';\n  inited = false;\n\n  constructor(element) {\n    this.element = $(element);\n\n    if (this.element.length > 0) {\n      this.init();\n      this.inited = true;\n    }\n\n    let $container = this.element.closest('#video-subtitle-form-group');\n    if ($container.find('#ext_mediaId_for_subtitle').val() > 0) {\n      this.render({id: $container.find('#ext_mediaId_for_subtitle').val()});\n    }\n  }\n\n  init() {\n\n    let self = this;\n    //删除字幕\n    this.element.on('click', '.js-subtitle-delete', function () {\n      let $elem = $(this);\n      $.post($elem.data('subtitleDeleteUrl'), function (data) {\n        if (data) {\n          notify('success', '删除字幕成功');\n          $elem.parent().remove();\n          $('#' + self.upload_id).show();\n        }\n      });\n    });\n  }\n\n\n  render(media) {\n    if (!this.inited) {\n      return;\n    }\n\n    if (media && 'id' in media && media.id > 0) {\n      this.media = media;\n      this.element.html('加载字幕...');\n      let self = this;\n      $.get(this.element.data('dialogUrl'), {mediaId: this.media.id}, function (html) {\n        self.element.html(html);\n        self.initUploader();\n      });\n    }\n  }\n\n  initUploader() {\n    let self = this;\n    let $elem = $('#' + this.upload_id);\n    let mediaId = $('.js-subtitle-dialog').data('mediaId');\n    let globalId = $elem.data('mediaGlobalId');\n\n    if (this.uploader) {\n      this._destroyUploader();\n    }\n    let uploader = new UploaderSDK({\n      initUrl: $elem.data('initUrl'),\n      finishUrl: $elem.data('finishUrl'),\n      id: this.upload_id,\n      ui: 'simple',\n      multi: true,\n      accept: {\n        extensions: ['srt'],\n        mimeTypes: ['text/srt']\n      },\n      type: 'sub',\n      process: {\n        videoNo: globalId,\n      }\n    });\n\n    uploader.on('error', function (err) {\n      if (err.error === 'Q_TYPE_DENIED') {\n        notify('danger', '请上传srt格式的文件！');\n      }\n    });\n\n    uploader.on('file.finish', function (file) {\n      $.post($elem.data('subtitleCreateUrl'), {\n        \"name\": file.name,\n        \"subtitleId\": file.id,\n        \"mediaId\": mediaId\n      }).success(function (data) {\n        let convertStatus = {\n          waiting: '等待转码',\n          doing: '正在转码',\n          success: '转码成功',\n          error: '转码失败',\n          none: '等待转码'\n        };\n        $('.js-media-subtitle-list').append('<li class=\"pvs\">' +\n          '<span class=\"subtitle-name prl\">' + data.name + '</span>' +\n          '<span class=\"subtitle-transcode-status ' + data.convertStatus + '\">' + convertStatus[data.convertStatus] + '</span>' +\n          '<a href=\"javascript:;\" class=\"btn-link pll color-primary js-subtitle-delete\" data-subtitle-delete-url=\"/media/' + mediaId + '/subtitle/' + data.id + '/delete\">删除</a>' +\n          '</li>');\n        if ($('.js-media-subtitle-list li').length > 3) {\n          $('#' + self.upload_id).hide();\n        }\n        notify('success', '字幕上传成功！');\n      }).error(function (data) {\n        notify('danger', data.responseJSON.error.message);\n      });\n    });\n\n    this.uploader = uploader;\n  }\n\n  show() {\n    let parent = this.element.parent('.form-group');\n    if (parent.length > 0) {\n      parent.removeClass('hide');\n    }\n  }\n\n  hide() {\n    let parent = this.element.parent('.form-group');\n    if (parent.length > 0) {\n      parent.addClass('hide');\n    }\n  }\n\n  _destroyUploader() {\n    if (!this.uploader) {\n      return;\n    }\n    this.uploader.__events = null;\n    try {\n      this.uploader.destroy();\n    } catch (e) {\n      //忽略destroy异常\n    }\n    this.uploader = null;\n  }\n\n  destroy() {\n    if (!this.inited) {\n      return;\n    }\n    this._destroyUploader();\n  }\n}\n\nexport default SubtitleDialog;"]}