webpackJsonp(["app/js/testpaper-manage/questions/index"],{0:function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _esEventEmitter=__webpack_require__("63fff8fb24f3bd1f61cd");_interopRequireDefault(_esEventEmitter);__webpack_require__("fab8cd7809cb4812a95e");var _batchSelect=__webpack_require__("de585ca0d3c2d0205c51"),_batchSelect2=_interopRequireDefault(_batchSelect),_questionOperate=__webpack_require__("1e0cf618bc778b8ab554"),_questionOperate2=_interopRequireDefault(_questionOperate),_manage=__webpack_require__("65c0e24ccad86ee24949"),_manage2=_interopRequireDefault(_manage),$testpaperItemsManager=$("#testpaper-items-manager");new _questionOperate2["default"]($testpaperItemsManager,$("#modal")),new _manage2["default"]($testpaperItemsManager),new _batchSelect2["default"]($testpaperItemsManager)},"65c0e24ccad86ee24949":function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_notify=__webpack_require__("b334fd7e4c5a19234db2"),_notify2=_interopRequireDefault(_notify),QuestionManage=function(){function QuestionManage($element){_classCallCheck(this,QuestionManage),this.$element=$element,this.$button=this.$element.find('[data-role="pick-item"]'),this.$typeNav=this.$element.find("#testpaper-question-nav"),this.$modal=$("#testpaper-confirm-modal"),this.currentType=this.$typeNav.find(".active").children().data("type"),this.questions=[],this._initEvent()}return _createClass(QuestionManage,[{key:"_initEvent",value:function(){var _this=this;this.$button.on("click",function(event){return _this._showPickerModal(event)}),this.$typeNav.on("click","li",function(event){return _this._changeNav(event)}),this.$element.on("click",".js-request-save",function(event){return _this._confirmSave(event)}),this.$modal.on("click",".js-confirm-submit",function(event){return _this._submitSave(event)})}},{key:"_showPickerModal",value:function(event){var excludeIds=[];$('[data-type="'+this.currentType+'"]').find('[name="questionIds[]"]').each(function(){excludeIds.push($(this).val())});var $modal=$("#modal").modal();$modal.data("manager",this),$.get(this.$button.data("url"),{excludeIds:excludeIds.join(","),type:this.currentType},function(html){$modal.html(html)})}},{key:"_changeNav",value:function(event){var $target=$(event.currentTarget),type=$target.children().data("type");this.currentType=type,this.$typeNav.find("li").removeClass("active"),$target.addClass("active"),this.$element.find('[data-role="question-body"]').addClass("hide"),this.$element.find("#testpaper-items-"+type).removeClass("hide"),this.$element.find('[data-role="batch-select"]').prop("checked",!1),this.$element.find('[data-role="batch-item"]').prop("checked",!1)}},{key:"_confirmSave",value:function(event){var isOk=this._validateScore();if(isOk){if($('[name="passedScore"]').length>0){var passedScoreErrorMsg=$(".passedScoreDiv").siblings(".help-block").html();if(""!=$.trim(passedScoreErrorMsg))return}var stats=this._calTestpaperStats(),html="";$.each(stats,function(index,statsItem){var tr="<tr>";tr+="<td>"+statsItem.name+"</td>",tr+="<td>"+statsItem.count+"</td>",tr+="<td>"+statsItem.score.toFixed(1)+"</td>",tr+="</tr>",html+=tr}),this.$modal.find(".detail-tbody").html(html),this.$modal.modal("show")}}},{key:"_validateScore",value:function(){var isOk=!0;return 0==this.$element.find('[name="scores[]"]').length&&((0,_notify2["default"])("danger","请选择题目。"),isOk=!1),this.$element.find('input[type="text"][name="scores[]"]').each(function(){var score=$(this).val();"0"==score&&((0,_notify2["default"])("danger","题目分值不能为0。"),isOk=!1),/^(([1-9]{1}\d{0,2})|([0]{1}))(\.(\d){1})?$/.test(score)||((0,_notify2["default"])("danger","题目分值只能填写数字，并且在3位数以内，保留一位小数。"),$(this).focus(),isOk=!1)}),isOk}},{key:"_calTestpaperStats",value:function(){var stats={},self=this;this.$typeNav.find("li").each(function(){var type=$(this).find("a").data("type"),name=$(this).find("a").data("name");stats[type]={name:name,count:0,score:0,missScore:0},self.$element.find("#testpaper-items-"+type).find('[name="scores[]"]').each(function(){var itemType=$(this).closest("tr").data("type"),score="material"==itemType?0:parseFloat($(this).val()),question={};"material"!=itemType&&stats[type].count++,stats[type].score+=score,stats[type].missScore=parseFloat($(this).data("miss-score"));var questionId=$(this).closest("tr").data("id");question.id=questionId,question.score=score,question.missScore=parseFloat($(this).data("miss-score")),question.type=type,self.questions.push(question)})});var total={name:Translator.trans("总计"),count:0,score:0};return $.each(stats,function(index,statsItem){total.count+=statsItem.count,total.score+=statsItem.score}),stats.total=total,stats}},{key:"_submitSave",value:function(event){var passedScore=0,$target=$(event.currentTarget);$('input[name="passedScore"]:visible').length>0&&(passedScore=$('input[name="passedScore"]').val()),$target.button("loading").addClass("disabled"),$.post(this.$element.attr("action"),{questions:this.questions,passedScore:passedScore},function(result){result["goto"]&&(window.location.href=result["goto"])})}}]),QuestionManage}();exports["default"]=QuestionManage}});