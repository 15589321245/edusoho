{"version":3,"sources":["app/Resources/static-src/app/js/testpaper-manage/questions/manage.js"],"names":["QuestionManage","$element","$button","find","$typeNav","$modal","$","currentType","children","data","questions","_initEvent","on","_showPickerModal","event","_changeNav","_confirmSave","_submitSave","excludeIds","each","push","val","modal","get","join","type","html","$target","currentTarget","removeClass","addClass","prop","isOk","_validateScore","length","passedScoreErrorMsg","siblings","trim","stats","_calTestpaperStats","index","statsItem","tr","name","count","score","toFixed","test","focus","self","missScore","itemType","closest","parseFloat","question","questionId","total","Translator","trans","passedScore","button","post","attr","result","goto","window","location","href"],"mappings":"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","file":"manage.js","sourceRoot":"/Users/kz/projects/edusoho","sourcesContent":["import notify from 'common/notify';\nexport default class QuestionManage{\n  constructor($element) {\n    this.$element = $element;\n    this.$button = this.$element.find('[data-role=\"pick-item\"]');\n    this.$typeNav = this.$element.find('#testpaper-question-nav');\n    this.$modal = $('#testpaper-confirm-modal');\n    this.currentType = this.$typeNav.find('.active').children().data('type');\n    this.questions = [];\n    this._initEvent();\n  }\n\n  _initEvent() {\n    this.$button.on('click',event => this._showPickerModal(event));\n    this.$typeNav.on('click','li', event => this._changeNav(event));\n    this.$element.on('click','.js-request-save',event => this._confirmSave(event));\n    this.$modal.on('click','.js-confirm-submit',event => this._submitSave(event));\n  }\n\n  _showPickerModal(event) {\n    let excludeIds = [];\n    $('[data-type=\"'+this.currentType+'\"]').find('[name=\"questionIds[]\"]').each(function(){\n        excludeIds.push($(this).val());\n    });\n\n    let $modal = $(\"#modal\").modal();\n    $modal.data('manager', this);\n    $.get(this.$button.data('url'), {excludeIds: excludeIds.join(','), type: this.currentType}, function(html) {\n        $modal.html(html);\n    });\n  }\n\n  _changeNav(event) {\n    let $target = $(event.currentTarget);\n    let type = $target.children().data('type');\n    this.currentType = type;\n\n    this.$typeNav.find('li').removeClass('active');\n    $target.addClass('active');\n\n    this.$element.find('[data-role=\"question-body\"]').addClass('hide');\n    this.$element.find('#testpaper-items-'+type).removeClass('hide');\n    this.$element.find('[data-role=\"batch-select\"]').prop('checked',false);\n    this.$element.find('[data-role=\"batch-item\"]').prop('checked',false);\n  }\n  _confirmSave(event) {\n    let isOk = this._validateScore();\n\n    if (!isOk) {\n        return ;\n    }\n\n    if( $('[name=\"passedScore\"]').length > 0){\n        let passedScoreErrorMsg = $('.passedScoreDiv').siblings('.help-block').html();\n        if ($.trim(passedScoreErrorMsg) != ''){\n            return ;\n        }\n    }\n\n    let stats = this._calTestpaperStats();\n    \n    let html='';\n    $.each(stats, function(index, statsItem){\n        let tr = \"<tr>\";\n            tr += \"<td>\" + statsItem.name + \"</td>\";\n            tr += \"<td>\" + statsItem.count + \"</td>\";\n            tr += \"<td>\" + statsItem.score.toFixed(1) + \"</td>\";\n            tr += \"</tr>\";\n        html += tr;\n    });\n\n    this.$modal.find('.detail-tbody').html(html);\n\n    this.$modal.modal('show');\n  }\n\n  _validateScore() {\n    let isOk = true;\n\n    if (this.$element.find('[name=\"scores[]\"]').length == 0) {\n        notify('danger','请选择题目。');\n        isOk = false;\n    }\n\n    this.$element.find('input[type=\"text\"][name=\"scores[]\"]').each(function() {\n        var score = $(this).val();\n\n        if (score == '0') {\n            notify('danger','题目分值不能为0。');\n            isOk = false;\n        }\n\n        if (!/^(([1-9]{1}\\d{0,2})|([0]{1}))(\\.(\\d){1})?$/.test(score)) {\n            notify('danger','题目分值只能填写数字，并且在3位数以内，保留一位小数。');\n            $(this).focus();\n            isOk = false;\n        }\n    });\n\n    return isOk;\n  }\n\n  _calTestpaperStats() {\n    let stats = {};\n    let self = this;\n\n    this.$typeNav.find('li').each(function() {\n        let type = $(this).find('a').data('type'),\n            name = $(this).find('a').data('name');\n            \n\n        stats[type] = {name:name, count:0, score:0, missScore:0};\n\n        self.$element.find('#testpaper-items-'+type).find('[name=\"scores[]\"]').each(function() {\n            let itemType = $(this).closest('tr').data('type');\n            let score = itemType == 'material' ? 0 : parseFloat($(this).val());\n            let question = {};\n\n            if (itemType != 'material') {\n              stats[type]['count'] ++;\n            }\n            \n            stats[type]['score'] += score;\n            stats[type]['missScore'] = parseFloat($(this).data('miss-score'));\n\n            let questionId = $(this).closest('tr').data('id');\n\n            question['id'] = questionId;\n            question['score'] = score;\n            question['missScore'] = parseFloat($(this).data('miss-score'));\n            question['type'] = type;\n            \n            self.questions.push(question);\n        });\n    });\n\n    let total = {name:Translator.trans('总计'), count:0, score:0};\n    $.each(stats, function(index, statsItem) {\n        total.count += statsItem.count;\n        total.score += statsItem.score;\n    });\n\n    stats.total = total;\n\n    return stats;\n  }\n\n  _submitSave(event) {\n    let passedScore = 0;\n    let $target = $(event.currentTarget);\n    if ($('input[name=\"passedScore\"]:visible').length > 0) {\n        passedScore = $('input[name=\"passedScore\"]').val();\n    }\n\n    $target.button('loading').addClass('disabled');\n    \n    $.post(this.$element.attr('action'),{questions:this.questions,passedScore:passedScore},function(result){\n      if (result.goto) {\n        window.location.href = result.goto;\n      }\n    })\n  }\n}"]}